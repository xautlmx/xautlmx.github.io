<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.7.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.koenli.com","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="注：本文参考360资深运维工程师李振良老师的《Kubernetes/K8S架构师实战训练营【中级班】》视频课程总结而成。部分内容和图片均来自于视频课程中。 在正式进行部署之前先了解下关于Kubernetes的几个核心知识点 Kubernetes是什么  Kubernetes是Google在2014年开源的一个容器集群管理系统，Kubernetes简称K8S。 K8S用于容器化应用程序的部署、扩展和">
<meta name="keywords" content="Docker">
<meta property="og:type" content="article">
<meta property="og:title" content="在CentOS7上二进制部署Kubernetes高可用集群">
<meta property="og:url" content="http://www.koenli.com/2e84845e.html">
<meta property="og:site_name" content="Koenli&#39;s Blog">
<meta property="og:description" content="注：本文参考360资深运维工程师李振良老师的《Kubernetes/K8S架构师实战训练营【中级班】》视频课程总结而成。部分内容和图片均来自于视频课程中。 在正式进行部署之前先了解下关于Kubernetes的几个核心知识点 Kubernetes是什么  Kubernetes是Google在2014年开源的一个容器集群管理系统，Kubernetes简称K8S。 K8S用于容器化应用程序的部署、扩展和">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://img.koenli.com/%E5%9C%A8CentOS7%E4%B8%8A%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4_1.jpg">
<meta property="og:image" content="https://img.koenli.com/%E5%9C%A8CentOS7%E4%B8%8A%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4_2.png">
<meta property="og:image" content="https://img.koenli.com/%E5%9C%A8CentOS7%E4%B8%8A%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4_3.png">
<meta property="og:image" content="https://img.koenli.com/%E5%9C%A8CentOS7%E4%B8%8A%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4_4.png">
<meta property="og:image" content="https://img.koenli.com/%E5%9C%A8CentOS7%E4%B8%8A%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4_5.png">
<meta property="og:image" content="https://img.koenli.com/%E5%9C%A8CentOS7%E4%B8%8A%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4_6.png">
<meta property="og:updated_time" content="2020-03-01T13:48:37.900Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="在CentOS7上二进制部署Kubernetes高可用集群">
<meta name="twitter:description" content="注：本文参考360资深运维工程师李振良老师的《Kubernetes/K8S架构师实战训练营【中级班】》视频课程总结而成。部分内容和图片均来自于视频课程中。 在正式进行部署之前先了解下关于Kubernetes的几个核心知识点 Kubernetes是什么  Kubernetes是Google在2014年开源的一个容器集群管理系统，Kubernetes简称K8S。 K8S用于容器化应用程序的部署、扩展和">
<meta name="twitter:image" content="https://img.koenli.com/%E5%9C%A8CentOS7%E4%B8%8A%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4_1.jpg">

<link rel="canonical" href="http://www.koenli.com/2e84845e.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>在CentOS7上二进制部署Kubernetes高可用集群 | Koenli's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Koenli's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">19</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">39</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.koenli.com/2e84845e.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Koenli">
      <meta itemprop="description" content="讨厌自己明明不甘平凡，却又不好好努力">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Koenli's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          在CentOS7上二进制部署Kubernetes高可用集群
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-08 19:24:50" itemprop="dateCreated datePublished" datetime="2019-12-08T19:24:50+08:00">2019-12-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-01 21:48:37" itemprop="dateModified" datetime="2020-03-01T21:48:37+08:00">2020-03-01</time>
              </span>

          
            <span id="/2e84845e.html" class="post-meta-item leancloud_visitors" data-flag-title="在CentOS7上二进制部署Kubernetes高可用集群" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2e84845e.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2e84845e.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>注：本文参考360资深运维工程师李振良老师的《Kubernetes/K8S架构师实战训练营【中级班】》视频课程总结而成。部分内容和图片均来自于视频课程中。</p>
<p>在正式进行部署之前先了解下关于Kubernetes的几个核心知识点</p>
<h1 id="Kubernetes是什么"><a href="#Kubernetes是什么" class="headerlink" title="Kubernetes是什么"></a>Kubernetes是什么</h1><hr>
<ul>
<li>Kubernetes是Google在2014年开源的一个容器集群管理系统，Kubernetes简称K8S。</li>
<li>K8S用于容器化应用程序的部署、扩展和管理</li>
<li>K8S提供了容器编排，资源调度，弹性伸缩，部署管理，服务发现等一系列功能。</li>
<li>Kubernetes目标是让部署容器化应用简单高效</li>
</ul>
<a id="more"></a>
<h1 id="Kubernetes特性"><a href="#Kubernetes特性" class="headerlink" title="Kubernetes特性"></a>Kubernetes特性</h1><hr>
<ul>
<li>自我修复</li>
</ul>
<p>在节点故障时重新启动失败的容器，替换和重新部署，保证预期的副本数量；杀死健康检查失败的容器，并且在未准备好之前不会处理客户端请求，确保上线服务不中断。</p>
<ul>
<li>弹性伸缩</li>
</ul>
<p>使用命令、UI或者基于CPU使用情况自动快速扩容和缩容应用程序实例，保证应用业务高峰并发时的高可用性；业务低峰时回收资源，以最小成本运行服务。</p>
<ul>
<li>自动部署和回滚</li>
</ul>
<p>K8S采用滚动更新策略更新应用，一次更新一个Pod，而不是同时删除所有Pod，如果更新过程中出现问题，将回滚更改，确保升级不会影响业务。</p>
<ul>
<li>服务发现和负载均衡</li>
</ul>
<p>K8S为多个容器提供一个统一访问入口（内部IP地址和一个DNS名称），并且负载均衡关联所有容器，使得用户无需考虑容器IP问题</p>
<ul>
<li>机密和配置管理</li>
</ul>
<p>管理机密数据和应用程序配置，而不需要把敏感数据暴露在镜像里，提高敏感数据安全性。并可以将一些常用的配置存储在K8S中，方便应用程序使用。</p>
<ul>
<li>存储编排</li>
</ul>
<p>挂载外部存储系统，无论是来自本地存储，公有云（如AWS），还是网络存储（如NFS、GlusterFS、Ceph）都作为集群资源的一部分使用，极大提高存储使用灵活性</p>
<ul>
<li>批处理</li>
</ul>
<p>提供一次性任务，定时任务；满足批量数据处理和分析的场景</p>
<h1 id="Kubernetes集群架构与组件"><a href="#Kubernetes集群架构与组件" class="headerlink" title="Kubernetes集群架构与组件"></a>Kubernetes集群架构与组件</h1><hr>
<p><img src="https://img.koenli.com/%E5%9C%A8CentOS7%E4%B8%8A%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4_1.jpg" alt=""></p>
<h2 id="Master组件"><a href="#Master组件" class="headerlink" title="Master组件"></a>Master组件</h2><ul>
<li>kube-apiserver</li>
</ul>
<p>Kubernetes API，集群的统一入口，各组件协调者，以RESTful API提供接口服务，所有对象资源的增删查改和监听操作都交给APIServer处理后再提交给etcd存储。</p>
<ul>
<li>kube-controller-manager</li>
</ul>
<p>处理集群中常规后台任务，一个资源对应一个控制器，而ControllerManager就是负责管理这些控制器的。</p>
<ul>
<li>kube-scheduler</li>
</ul>
<p>根据调度算法为新创建的Pod选择一个Node节点，可以任意部署，可以部署在同一个节点，也可以部署在不同的节点上。</p>
<ul>
<li>etcd</li>
</ul>
<p>分布式键值存储系统。用于保存集群状态数据，比如Pod、Service等对象信息。</p>
<h2 id="Node组件"><a href="#Node组件" class="headerlink" title="Node组件"></a>Node组件</h2><ul>
<li>kubelet</li>
</ul>
<p>kubelet是Master在Node节点上的Agent，管理本机运行容器的生命周期，比如创建容器、Pod挂载数据卷、下载secret、获取容器和节点状态等工作。kubelet将每个Pod转换成一组容器。</p>
<ul>
<li>kube-proxy</li>
</ul>
<p>在Node节点上实现Pod网络代理，维护网络规则和四层负载均衡工作</p>
<ul>
<li>docker或rocket</li>
</ul>
<p>容器引擎，运行容器</p>
<h1 id="Kubernetes核心概念"><a href="#Kubernetes核心概念" class="headerlink" title="Kubernetes核心概念"></a>Kubernetes核心概念</h1><hr>
<h2 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h2><ul>
<li>最小部署单元</li>
<li>一组容器的集合</li>
<li>一个Pod中的容器共享网络命名空间</li>
<li>Pod是暂短的</li>
</ul>
<h2 id="Controllers"><a href="#Controllers" class="headerlink" title="Controllers"></a>Controllers</h2><ul>
<li>ReplicaSet：确保预期的Pod副本数量</li>
<li>Deployment：无状态应用部署</li>
<li>StatefulSet：有状态应用部署</li>
<li>DaemonSet：确保所有Node运行同一个Pod</li>
<li>Job：一次性任务</li>
<li>CronJob：定时任务</li>
</ul>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><ul>
<li>防止Pod失联</li>
<li>定义一组Pod的访问策略</li>
</ul>
<h2 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h2><p>标签，附加到某个资源上，用于关联对象、查询和筛选</p>
<h2 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h2><p>命名空间，将对象逻辑上分离</p>
<h1 id="生产环境K8S平台规划"><a href="#生产环境K8S平台规划" class="headerlink" title="生产环境K8S平台规划"></a>生产环境K8S平台规划</h1><hr>
<h2 id="单Master集群"><a href="#单Master集群" class="headerlink" title="单Master集群"></a>单Master集群</h2><p><img src="https://img.koenli.com/%E5%9C%A8CentOS7%E4%B8%8A%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4_2.png" alt=""></p>
<h2 id="多Master集群-HA"><a href="#多Master集群-HA" class="headerlink" title="多Master集群(HA)"></a>多Master集群(HA)</h2><p><img src="https://img.koenli.com/%E5%9C%A8CentOS7%E4%B8%8A%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4_3.png" alt=""></p>
<h1 id="服务器硬件配置推荐"><a href="#服务器硬件配置推荐" class="headerlink" title="服务器硬件配置推荐"></a>服务器硬件配置推荐</h1><hr>
<h2 id="Mater节点"><a href="#Mater节点" class="headerlink" title="Mater节点"></a>Mater节点</h2><ul>
<li><p>物理机虚拟机均可，至少1台，高可用集群至少2台（etcd集群必须奇数台）</p>
</li>
<li><p>配置推荐：实验环境2核2G、测试环境2核4G、生产环境8核16G</p>
</li>
<li><p>关闭所有swap分区或不划分swap分区</p>
</li>
</ul>
<h2 id="Node节点"><a href="#Node节点" class="headerlink" title="Node节点"></a>Node节点</h2><ul>
<li><p>物理机虚拟机均可，大于等于1台</p>
</li>
<li><p>配置推荐：实验环境2核2G、测试环境4核8G、生产环境16核64G</p>
</li>
<li><p>关闭所有swap分区或不划分swap分区</p>
</li>
</ul>
<h1 id="实验环境信息"><a href="#实验环境信息" class="headerlink" title="实验环境信息"></a>实验环境信息</h1><hr>
<table>
<thead>
<tr>
<th style="text-align:center">主机名</th>
<th style="text-align:center">配置</th>
<th style="text-align:center">操作系统</th>
<th style="text-align:center">IP地址</th>
<th style="text-align:center">角色</th>
<th style="text-align:center">组件</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">k8s-master1</td>
<td style="text-align:center">2核2G</td>
<td style="text-align:center">CentOS7.5</td>
<td style="text-align:center">10.211.55.4</td>
<td style="text-align:center">master</td>
<td style="text-align:center">kube-apiserver<br>kube-controller-manager<br>kube-scheduler<br>etcd<br>nginx</td>
</tr>
<tr>
<td style="text-align:center">k8s-master2</td>
<td style="text-align:center">2核2G</td>
<td style="text-align:center">CentOS7.5</td>
<td style="text-align:center">10.211.55.7</td>
<td style="text-align:center">master</td>
<td style="text-align:center">kube-apiserver<br>kube-controller-manager<br>kube-scheduler<br>nginx</td>
</tr>
<tr>
<td style="text-align:center">k8s-node1</td>
<td style="text-align:center">2核2G</td>
<td style="text-align:center">CentOS7.5</td>
<td style="text-align:center">10.211.55.5</td>
<td style="text-align:center">node</td>
<td style="text-align:center">kubelet<br>kube-proxy<br>docker<br>etcd</td>
</tr>
<tr>
<td style="text-align:center">k8s-node2</td>
<td style="text-align:center">2核2G</td>
<td style="text-align:center">CentOS7.5</td>
<td style="text-align:center">10.211.55.6</td>
<td style="text-align:center">node</td>
<td style="text-align:center">kubelet<br>kube-proxy<br>docker<br>etcd</td>
</tr>
</tbody>
</table>
<p>VIP:10.211.55.10</p>
<h1 id="系统初始化"><a href="#系统初始化" class="headerlink" title="系统初始化"></a>系统初始化</h1><hr>
<h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure>
<h2 id="关闭selinux"><a href="#关闭selinux" class="headerlink" title="关闭selinux"></a>关闭selinux</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">sed -i "s/^SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config</span><br></pre></td></tr></table></figure>
<h2 id="关闭swap"><a href="#关闭swap" class="headerlink" title="关闭swap"></a>关闭swap</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br><span class="line">echo 'swapoff -a ' &gt;&gt; /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure>
<h2 id="配置主机名"><a href="#配置主机名" class="headerlink" title="配置主机名"></a>配置主机名</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname &lt;hostname&gt;</span><br></pre></td></tr></table></figure>
<h2 id="添加所有节点的本地host解析"><a href="#添加所有节点的本地host解析" class="headerlink" title="添加所有节点的本地host解析"></a>添加所有节点的本地host解析</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">x.x.x.x hostname1</span><br><span class="line">y.y.y.y hostname2</span><br><span class="line">...</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="安装基础软件包"><a href="#安装基础软件包" class="headerlink" title="安装基础软件包"></a>安装基础软件包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install vim net-tools lrzsz unzip dos2unix telnet sysstat iotop pciutils lsof tcpdump psmisc bc wget socat -y</span><br></pre></td></tr></table></figure>
<h2 id="内核开启网络支持"><a href="#内核开启网络支持" class="headerlink" title="内核开启网络支持"></a>内核开启网络支持</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.ipv4.ip_nonlocal_bind = 1</span><br><span class="line">EOF</span><br><span class="line">modprobe br_netfilter</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>
<h2 id="配置所有master到所有节点（包括自身）的ssh免密登录"><a href="#配置所有master到所有节点（包括自身）的ssh免密登录" class="headerlink" title="配置所有master到所有节点（包括自身）的ssh免密登录"></a>配置所有master到所有节点（包括自身）的ssh免密登录</h2><p>依此在所有的master节点上做如下操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub k8s-master1</span><br></pre></td></tr></table></figure>
<h2 id="节点之间时间同步"><a href="#节点之间时间同步" class="headerlink" title="节点之间时间同步"></a>节点之间时间同步</h2><h3 id="server端"><a href="#server端" class="headerlink" title="server端"></a>server端</h3><p><strong>注：</strong>如果环境可以访问互联网，可以不需要自己搭建server端，参考后面的client端部分设置所有节点与公网ntp时间服务器(例如time1.cloud.tencent.com)同步时间即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装chrony并备份配置文件</span></span><br><span class="line">yum install chrony ntpdate -y</span><br><span class="line">cp -a /etc/chrony.conf /etc/chrony.conf.bak</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">修改server端配置文件如下，标注的地方需要修改</span></span><br><span class="line">cat &gt; /etc/chrony.conf &lt;&lt; EOF</span><br><span class="line">stratumweight 0</span><br><span class="line">driftfile /var/lib/chrony/drift</span><br><span class="line">rtcsync</span><br><span class="line">makestep 10 3</span><br><span class="line">allow 10.211.55.0/24    #设置为实际环境客户端所属IP网段</span><br><span class="line">smoothtime 400 0.01</span><br><span class="line"> </span><br><span class="line">bindcmdaddress 127.0.0.1</span><br><span class="line">bindcmdaddress ::1</span><br><span class="line"> </span><br><span class="line">local stratum 8</span><br><span class="line">manual</span><br><span class="line">keyfile /etc/chrony.keys</span><br><span class="line"><span class="meta">#</span><span class="bash">initstepslew 10 client1 client3 client6</span></span><br><span class="line">noclientlog</span><br><span class="line">logchange 0.5</span><br><span class="line">logdir /var/log/chrony</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">启动服务，设置开机自启</span></span><br><span class="line">systemctl restart chronyd.service</span><br><span class="line">systemctl enable  chronyd.service</span><br><span class="line">systemctl status chronyd.service</span><br></pre></td></tr></table></figure>
<h3 id="client端"><a href="#client端" class="headerlink" title="client端"></a>client端</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装chrony并备份配置文件</span></span><br><span class="line">yum install chrony ntpdate -y</span><br><span class="line">cp -a /etc/chrony.conf /etc/chrony.conf.bak</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">修改client端配置文件</span></span><br><span class="line">sed -i "s%^server%#server%g" /etc/chrony.conf</span><br><span class="line">echo "server 10.211.55.4 iburst" &gt;&gt; /etc/chrony.conf    #添加一行，其中的IP地址替换为实际环境server端的IP地址</span><br><span class="line"></span><br><span class="line">ntpdate  10.211.55.4    #手动同步一次时间，其中的IP地址替换为实际环境server端的IP地址</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">启动服务，设置开机自启</span></span><br><span class="line">systemctl restart chronyd.service</span><br><span class="line">systemctl enable  chronyd.service</span><br><span class="line">systemctl status chronyd.service</span><br><span class="line"></span><br><span class="line">chronyc  sources    #查看ntp_servers状态</span><br><span class="line">chronyc  tracking    #查看ntp详细信息</span><br></pre></td></tr></table></figure>
<h1 id="安装CFSSL工具"><a href="#安装CFSSL工具" class="headerlink" title="安装CFSSL工具"></a>安装CFSSL工具</h1><hr>
<pre><code>CFSSL是CloudFlare开源的一款PKI/TLS工具。 CFSSL 包含一个命令行工具 和一个用于 签名，验证并且捆绑TLS证书的 HTTP API 服务。 使用Go语言编写
</code></pre><p>Github地址：<a href="https://github.com/cloudflare/cfssl" target="_blank" rel="noopener">https://github.com/cloudflare/cfssl</a></p>
<p>官网地址：<a href="https://pkg.cfssl.org/" target="_blank" rel="noopener">https://pkg.cfssl.org/</a></p>
<p>在其中一台节点（一般是master1）上执行如下指令直接进行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -s -L -o /usr/local/bin/cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">curl -s -L -o /usr/local/bin/cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">curl -s -L -o /usr/local/bin/cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line">chmod +x /usr/local/bin/cfssl*</span><br></pre></td></tr></table></figure>
<p>如果环境无法联网，则到官网下载最新版本的cfssl_linux-amd64、cfssljson_linux-amd64、cfssl-certinfo_linux-amd64并上传到其中一台节点的/root目录下（一般是master1），并执行如下指令安装cfssl</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line">mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line">mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo</span><br><span class="line">chmod +x /usr/local/bin/cfssl*</span><br></pre></td></tr></table></figure>
<h1 id="部署etcd数据库集群"><a href="#部署etcd数据库集群" class="headerlink" title="部署etcd数据库集群"></a>部署etcd数据库集群</h1><hr>
<pre><code>etcd 是基于 Raft 的分布式 key-value 存储系统，由 CoreOS 开发，常用于服务发现、共享配置以及并发控制（如 leader 选举、分布式锁等）。kubernetes 使用 etcd 存储所有运行数据。
</code></pre><p>Github地址：<a href="https://github.com/etcd-io/etcd" target="_blank" rel="noopener">https://github.com/etcd-io/etcd</a><br>官网地址：<a href="https://etcd.io/" target="_blank" rel="noopener">https://etcd.io/</a></p>
<h2 id="使用cfssl为etcd生成自签证书"><a href="#使用cfssl为etcd生成自签证书" class="headerlink" title="使用cfssl为etcd生成自签证书"></a>使用cfssl为etcd生成自签证书</h2><p>在安装了cfssl工具的节点上执行如下指令为etcd创建对应的ca机构并生成自签证书</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建工作目录</span></span><br><span class="line">mkdir /root/etcd-cert &amp;&amp; cd /root/etcd-cert</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建ca-csr.json文件</span></span><br><span class="line"></span><br><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    "CN": "etcd CA",</span><br><span class="line">    "key": &#123;</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    "names": [</span><br><span class="line">        &#123;</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "L": "ShenZhen",</span><br><span class="line">            "ST": "ShenZhen"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建ca-config.json文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">配置证书生成策略，让CA软件知道颁发什么样的证书</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ca-config.json：定义多个profiles,分别指定不同的过期时间，使用场景等参数，这里我们只定义了etcd一个profile</span></span><br><span class="line"><span class="meta">#</span><span class="bash">signing：表示该证书可用于签名其它证书</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server auth：表示client可以使用该CA对server提供的证书进行验证</span></span><br><span class="line"><span class="meta">#</span><span class="bash">client auth：表示server可以用该CA对client提供的证书进行验证</span></span><br><span class="line"></span><br><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  "signing": &#123;</span><br><span class="line">    "default": &#123;</span><br><span class="line">      "expiry": "876000h"</span><br><span class="line">    &#125;,</span><br><span class="line">    "profiles": &#123;</span><br><span class="line">      "etcd": &#123;</span><br><span class="line">         "expiry": "876000h",</span><br><span class="line">         "usages": [</span><br><span class="line">            "signing",</span><br><span class="line">            "key encipherment",</span><br><span class="line">            "server auth",</span><br><span class="line">            "client auth"</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建etcd-csr.json文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">注：etcd-csr.json中的hosts字段需要所把有etcd集群节点的IP地址都添加进去</span></span><br><span class="line"></span><br><span class="line">cat &gt; etcd-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    "CN": "etcd",</span><br><span class="line">    "hosts": [</span><br><span class="line">        "10.211.55.4",</span><br><span class="line">        "10.211.55.5",</span><br><span class="line">        "10.211.55.6"</span><br><span class="line">        ],</span><br><span class="line">    "key": &#123;</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    "names": [</span><br><span class="line">        &#123;</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "L": "ShenZhen",</span><br><span class="line">            "ST": "ShenZhen"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">生成CA证书和私钥</span></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">为etcd生成自签证书</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=etcd etcd-csr.json | cfssljson -bare etcd</span><br></pre></td></tr></table></figure>
<h2 id="部署etcd3-4之前版本"><a href="#部署etcd3-4之前版本" class="headerlink" title="部署etcd3.4之前版本"></a>部署etcd3.4之前版本</h2><p>访问<a href="https://github.com/etcd-io/etcd/releases" target="_blank" rel="noopener">https://github.com/etcd-io/etcd/releases</a>下载etcd3.4之前版本的二进制包（本文以3.3.18为例），并上传到其中一台etcd节点的/root目录下，然后执行如下指令解压并创建etcd相关目录和配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">解压到/opt</span></span><br><span class="line">cd /root/</span><br><span class="line">tar zxf etcd-v3.3.18-linux-amd64.tar.gz -C /opt/</span><br><span class="line">mv /opt/etcd-v3.3.18-linux-amd64/ /opt/etcd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建二进制文件存放目录、配置文件存放目录、证书存放目录</span></span><br><span class="line">mkdir /opt/etcd/bin</span><br><span class="line">mkdir /opt/etcd/cfg</span><br><span class="line">mkdir /opt/etcd/ssl</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">拷贝二进制文件到bin目录下</span></span><br><span class="line">cp -a /opt/etcd/etcd* /opt/etcd/bin/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">拷贝上一步生成的自签证书到ssl目录下</span></span><br><span class="line">cp -a /root/etcd-cert/&#123;ca,etcd,etcd-key&#125;.pem /opt/etcd/ssl/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建etcd集群配置文件，标注部分按实际情况进行修改</span></span><br><span class="line">cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; EOF</span><br><span class="line"><span class="meta">#</span><span class="bash">[Member]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">自定义此etcd节点的名称，集群内唯一</span></span><br><span class="line">ETCD_NAME="etcd-1"</span><br><span class="line"><span class="meta">#</span><span class="bash">定义etcd数据存放目录</span></span><br><span class="line">ETCD_DATA_DIR="/var/lib/etcd/default.etcd"</span><br><span class="line"><span class="meta">#</span><span class="bash">定义本机和成员之间通信的地址</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS="https://10.211.55.4:2380" </span><br><span class="line"><span class="meta">#</span><span class="bash">定义etcd对外提供服务的地址</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS="https://10.211.55.4:2379"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">[Clustering]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">定义该节点成员对等URL地址，且会通告集群的其余成员节点</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS="https://10.211.55.4:2380"</span><br><span class="line"><span class="meta">#</span><span class="bash">此成员的客户端URL列表，用于通告群集的其余部分</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS="https://10.211.55.4:2379"</span><br><span class="line"><span class="meta">#</span><span class="bash">集群中所有节点的信息</span></span><br><span class="line">ETCD_INITIAL_CLUSTER="etcd-1=https://10.211.55.4:2380,etcd-2=https://10.211.55.5:2380,etcd-3=https://10.211.55.6:2380"</span><br><span class="line"><span class="meta">#</span><span class="bash">创建集群的token，这个值每个集群保持唯一</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"</span><br><span class="line"><span class="meta">#</span><span class="bash">设置new为初始静态或DNS引导期间出现的所有成员。如果将此选项设置为existing，则etcd将尝试加入现有群集</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE="new"</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建etcd的systemd unit文件</span></span><br><span class="line">vim /usr/lib/systemd/system/etcd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/opt/etcd/cfg/etcd.conf</span><br><span class="line">ExecStart=/opt/etcd/bin/etcd \</span><br><span class="line">        --name=$&#123;ETCD_NAME&#125; \</span><br><span class="line">        --data-dir=$&#123;ETCD_DATA_DIR&#125; \</span><br><span class="line">        --listen-peer-urls=$&#123;ETCD_LISTEN_PEER_URLS&#125; \</span><br><span class="line">        --listen-client-urls=$&#123;ETCD_LISTEN_CLIENT_URLS&#125;,http://127.0.0.1:2379 \</span><br><span class="line">        --advertise-client-urls=$&#123;ETCD_ADVERTISE_CLIENT_URLS&#125; \</span><br><span class="line">        --initial-advertise-peer-urls=$&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125; \</span><br><span class="line">        --initial-cluster=$&#123;ETCD_INITIAL_CLUSTER&#125; \</span><br><span class="line">        --initial-cluster-token=$&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125; \</span><br><span class="line">        --initial-cluster-state=new \</span><br><span class="line">        --cert-file=/opt/etcd/ssl/etcd.pem \</span><br><span class="line">        --key-file=/opt/etcd/ssl/etcd-key.pem \</span><br><span class="line">        --peer-cert-file=/opt/etcd/ssl/etcd.pem \</span><br><span class="line">        --peer-key-file=/opt/etcd/ssl/etcd-key.pem \</span><br><span class="line">        --trusted-ca-file=/opt/etcd/ssl/ca.pem \</span><br><span class="line">        --peer-trusted-ca-file=/opt/etcd/ssl/ca.pem</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>将etcd目录和systemd unit文件拷贝到其余etcd集群节点上，并修改etcd配置文件中的<strong>名称</strong>和<strong>IP地址</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">拷贝etcd目录和etcd.service到其余etcd集群节点上</span></span><br><span class="line">scp -r /opt/etcd/ k8s-node1:/opt/</span><br><span class="line">scp -r /usr/lib/systemd/system/etcd.service k8s-node1:/usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">修改etcd集群配置文件，标注部分按实际情况进行修改</span></span><br><span class="line">vim /opt/etcd/cfg/etcd.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">[Member]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">自定义此etcd节点的名称，集群内唯一</span></span><br><span class="line">ETCD_NAME="etcd-1"</span><br><span class="line"><span class="meta">#</span><span class="bash">定义etcd数据存放目录</span></span><br><span class="line">ETCD_DATA_DIR="/var/lib/etcd/default.etcd"</span><br><span class="line"><span class="meta">#</span><span class="bash">定义本机和成员之间通信的地址</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS="https://10.211.55.4:2380" </span><br><span class="line"><span class="meta">#</span><span class="bash">定义etcd对外提供服务的地址</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS="https://10.211.55.4:2379"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">[Clustering]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">定义该节点成员对等URL地址，且会通告集群的其余成员节点</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS="https://10.211.55.4:2380"</span><br><span class="line"><span class="meta">#</span><span class="bash">此成员的客户端URL列表，用于通告群集的其余部分</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS="https://10.211.55.4:2379"</span><br><span class="line"><span class="meta">#</span><span class="bash">集群中所有节点的信息</span></span><br><span class="line">ETCD_INITIAL_CLUSTER="etcd-1=https://10.211.55.4:2380,etcd-2=https://10.211.55.5:2380,etcd-3=https://10.211.55.6:2380"</span><br><span class="line"><span class="meta">#</span><span class="bash">创建集群的token，这个值每个集群保持唯一</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"</span><br><span class="line"><span class="meta">#</span><span class="bash">设置new为初始静态或DNS引导期间出现的所有成员。如果将此选项设置为existing，则etcd将尝试加入现有群集</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE="new"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>在所有etcd集群节点上启动etcd并设置开机自启</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable etcd</span><br><span class="line">systemctl start etcd</span><br><span class="line">#注：在第一台节点上执行start后会一直卡着无法返回命令提示符，这是因为在等待其他节点准备就绪，继续启动其余节点即可</span><br><span class="line"></span><br><span class="line">systemctl status etcd</span><br></pre></td></tr></table></figure>
<p>在任意etcd节点上执行如下指令查看集群状态，若所有节点均处于healthy状态则表示etcd集群部署成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/etcd/bin/etcdctl --ca-file=/opt/etcd/ssl/ca.pem --cert-file=/opt/etcd/ssl/etcd.pem --key-file=/opt/etcd/ssl/etcd-key.pem --endpoints="https://10.211.55.4:2379,https://10.211.55.5:2379,https://10.211.55.6:2379" cluster-health</span><br></pre></td></tr></table></figure>
<h2 id="部署etcd3-4版本"><a href="#部署etcd3-4版本" class="headerlink" title="部署etcd3.4版本"></a>部署etcd3.4版本</h2><p>访问<a href="https://github.com/etcd-io/etcd/releases" target="_blank" rel="noopener">https://github.com/etcd-io/etcd/releases</a>下载etcd3.4版本的二进制包（本文以3.4.3为例），并上传到其中一台etcd节点的/root目录下，然后执行如下指令解压并创建etcd相关目录和配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">解压到/opt</span></span><br><span class="line">cd /root/</span><br><span class="line">tar zxf etcd-v3.4.3-linux-amd64.tar.gz -C /opt/</span><br><span class="line">mv /opt/etcd-v3.4.3-linux-amd64/ /opt/etcd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建二进制文件存放目录、配置文件存放目录、证书存放目录</span></span><br><span class="line">mkdir /opt/etcd/bin</span><br><span class="line">mkdir /opt/etcd/cfg</span><br><span class="line">mkdir /opt/etcd/ssl</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">拷贝二进制文件到bin目录下</span></span><br><span class="line">cp -a /opt/etcd/etcd* /opt/etcd/bin/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">拷贝上一步生成的自签证书到ssl目录下</span></span><br><span class="line">cp -a /root/etcd-cert/&#123;ca,etcd,etcd-key&#125;.pem /opt/etcd/ssl/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建etcd集群配置文件，标注部分按实际情况进行修改</span></span><br><span class="line">cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; EOF</span><br><span class="line"><span class="meta">#</span><span class="bash">[Member]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">自定义此etcd节点的名称，集群内唯一</span></span><br><span class="line">ETCD_NAME="etcd-1"</span><br><span class="line"><span class="meta">#</span><span class="bash">定义etcd数据存放目录</span></span><br><span class="line">ETCD_DATA_DIR="/var/lib/etcd/default.etcd"</span><br><span class="line"><span class="meta">#</span><span class="bash">定义本机和成员之间通信的地址</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS="https://10.211.55.4:2380" </span><br><span class="line"><span class="meta">#</span><span class="bash">定义etcd对外提供服务的地址</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS="https://10.211.55.4:2379,http://127.0.0.1:2379"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">[Clustering]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">定义该节点成员对等URL地址，且会通告集群的其余成员节点</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS="https://10.211.55.4:2380"</span><br><span class="line"><span class="meta">#</span><span class="bash">此成员的客户端URL列表，用于通告群集的其余部分</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS="https://10.211.55.4:2379"</span><br><span class="line"><span class="meta">#</span><span class="bash">集群中所有节点的信息</span></span><br><span class="line">ETCD_INITIAL_CLUSTER="etcd-1=https://10.211.55.4:2380,etcd-2=https://10.211.55.5:2380,etcd-3=https://10.211.55.6:2380"</span><br><span class="line"><span class="meta">#</span><span class="bash">创建集群的token，这个值每个集群保持唯一</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"</span><br><span class="line"><span class="meta">#</span><span class="bash">设置new为初始静态或DNS引导期间出现的所有成员。如果将此选项设置为existing，则etcd将尝试加入现有群集</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE="new"</span><br><span class="line"><span class="meta">#</span><span class="bash">flannel操作etcd使用的是v2的API，而kubernetes操作etcd使用的v3的API，在最新版ETCD3.4版本中默认关闭v2版本，所以为了兼容flannel，要设置开启v2的API</span></span><br><span class="line">ETCD_ENABLE_V2="true"</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建etcd的systemd unit文件</span></span><br><span class="line">vim /usr/lib/systemd/system/etcd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/opt/etcd/cfg/etcd.conf</span><br><span class="line">ExecStart=/opt/etcd/bin/etcd \</span><br><span class="line">        --cert-file=/opt/etcd/ssl/etcd.pem \</span><br><span class="line">        --key-file=/opt/etcd/ssl/etcd-key.pem \</span><br><span class="line">        --peer-cert-file=/opt/etcd/ssl/etcd.pem \</span><br><span class="line">        --peer-key-file=/opt/etcd/ssl/etcd-key.pem \</span><br><span class="line">        --trusted-ca-file=/opt/etcd/ssl/ca.pem \</span><br><span class="line">        --peer-trusted-ca-file=/opt/etcd/ssl/ca.pem</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>将etcd目录和systemd unit文件拷贝到其余etcd集群节点上，并修改etcd配置文件中的<strong>名称</strong>和<strong>IP地址</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">拷贝etcd目录和etcd.service到其余etcd集群节点上</span></span><br><span class="line">scp -r /opt/etcd/ k8s-node1:/opt/</span><br><span class="line">scp -r /usr/lib/systemd/system/etcd.service k8s-node1:/usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">修改etcd集群配置文件</span></span><br><span class="line">vim /opt/etcd/cfg/etcd.conf</span><br><span class="line"><span class="meta">#</span><span class="bash">[Member]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">自定义此etcd节点的名称，集群内唯一</span></span><br><span class="line">ETCD_NAME="etcd-1"</span><br><span class="line"><span class="meta">#</span><span class="bash">定义etcd数据存放目录</span></span><br><span class="line">ETCD_DATA_DIR="/var/lib/etcd/default.etcd"</span><br><span class="line"><span class="meta">#</span><span class="bash">定义本机和成员之间通信的地址</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS="https://10.211.55.4:2380" </span><br><span class="line"><span class="meta">#</span><span class="bash">定义etcd对外提供服务的地址</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS="https://10.211.55.4:2379,http://127.0.0.1:2379"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">[Clustering]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">定义该节点成员对等URL地址，且会通告集群的其余成员节点</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS="https://10.211.55.4:2380"</span><br><span class="line"><span class="meta">#</span><span class="bash">此成员的客户端URL列表，用于通告群集的其余部分</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS="https://10.211.55.4:2379"</span><br><span class="line"><span class="meta">#</span><span class="bash">集群中所有节点的信息</span></span><br><span class="line">ETCD_INITIAL_CLUSTER="etcd-1=https://10.211.55.4:2380,etcd-2=https://10.211.55.5:2380,etcd-3=https://10.211.55.6:2380"</span><br><span class="line"><span class="meta">#</span><span class="bash">创建集群的token，这个值每个集群保持唯一</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"</span><br><span class="line"><span class="meta">#</span><span class="bash">设置new为初始静态或DNS引导期间出现的所有成员。如果将此选项设置为existing，则etcd将尝试加入现有群集</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE="new"</span><br><span class="line"><span class="meta">#</span><span class="bash">flannel操作etcd使用的是v2的API，而kubernetes操作etcd使用的v3的API，在最新版ETCD3.4版本中默认关闭v2版本，所以为了兼容flannel，要设置开启v2的API</span></span><br><span class="line">ETCD_ENABLE_V2="true"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>在所有etcd集群节点上设置etcd开机自启并启动etcd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable etcd</span><br><span class="line">systemctl start etcd</span><br><span class="line">#注：在第一台节点上执行start后会一直卡着无法返回命令提示符，这是因为在等待其他节点准备就绪，继续启动其余节点即可</span><br><span class="line"></span><br><span class="line">systemctl status etcd</span><br></pre></td></tr></table></figure>
<p>在任意etcd节点上执行如下指令查看集群状态，若所有节点均处于healthy状态则表示etcd集群部署成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/etcd.pem --key=/opt/etcd/ssl/etcd-key.pem --endpoints="https://10.211.55.4:2379,https://10.211.55.5:2379,https://10.211.55.6:2379" endpoint health</span><br></pre></td></tr></table></figure>
<h2 id="卸载etcd"><a href="#卸载etcd" class="headerlink" title="卸载etcd"></a>卸载etcd</h2><p>若安装失败需要卸载重新安装，在所有etcd节点上执行如下指令即可:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop etcd</span><br><span class="line">systemctl disable etcd</span><br><span class="line">rm -rf /opt/etcd/</span><br><span class="line">rm -rf /usr/lib/systemd/system/etcd.service</span><br><span class="line">rm -rf /var/lib/etcd/</span><br></pre></td></tr></table></figure>
<h1 id="部署Master组件"><a href="#部署Master组件" class="headerlink" title="部署Master组件"></a>部署Master组件</h1><hr>
<h2 id="使用cfssl为apiserver和kube-proxy生成自签证书"><a href="#使用cfssl为apiserver和kube-proxy生成自签证书" class="headerlink" title="使用cfssl为apiserver和kube-proxy生成自签证书"></a>使用cfssl为apiserver和kube-proxy生成自签证书</h2><p>在安装了cfssl工具的节点上执行如下指令为apiserver和kube-proxy创建对应的ca机构并生成自签证书</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建工作目录</span></span><br><span class="line">mkdir /root/k8s-cert &amp;&amp; cd /root/k8s-cert</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">配置ca-csr.json</span></span><br><span class="line"></span><br><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    "CN": "kubernetes",</span><br><span class="line">    "key": &#123;</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    "names": [</span><br><span class="line">        &#123;</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "L": "ShenZhen",</span><br><span class="line">            "ST": "ShenZhen",</span><br><span class="line">      	    "O": "k8s",</span><br><span class="line">            "OU": "System"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建ca-config.json文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">配置证书生成策略，让CA软件知道颁发什么样的证书</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ca-config.json：定义多个profiles,分别指定不同的过期时间，使用场景等参数，这里我们只定义了etcd一个profile</span></span><br><span class="line"><span class="meta">#</span><span class="bash">signing：表示该证书可用于签名其它证书</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server auth：表示client可以使用该CA对server提供的证书进行验证</span></span><br><span class="line"><span class="meta">#</span><span class="bash">client auth：表示server可以用该CA对client提供的证书进行验证</span></span><br><span class="line"></span><br><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  "signing": &#123;</span><br><span class="line">    "default": &#123;</span><br><span class="line">      "expiry": "876000h"</span><br><span class="line">    &#125;,</span><br><span class="line">    "profiles": &#123;</span><br><span class="line">      "kubernetes": &#123;</span><br><span class="line">         "expiry": "876000h",</span><br><span class="line">         "usages": [</span><br><span class="line">            "signing",</span><br><span class="line">            "key encipherment",</span><br><span class="line">            "server auth",</span><br><span class="line">            "client auth"</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建apiserver-csr.json文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">注：hosts字段需要把所有master节点、负载均衡节点的IP地址和VIP地址，还有规划的service-cluster-ip-range（在kube-apiserver.conf和kube-controller-manager.conf中配置）的第一个IP地址（本例中为10.0.0.1）都添加进去，其中的127.0.0.1和kubernetes.*部分不要修改</span></span><br><span class="line">cat &gt; apiserver-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    "CN": "kubernetes",</span><br><span class="line">    "hosts": [</span><br><span class="line">      "10.0.0.1",</span><br><span class="line">      "127.0.0.1",</span><br><span class="line">      "kubernetes",</span><br><span class="line">      "kubernetes.default",</span><br><span class="line">      "kubernetes.default.svc",</span><br><span class="line">      "kubernetes.default.svc.cluster",</span><br><span class="line">      "kubernetes.default.svc.cluster.local",</span><br><span class="line">      "10.211.55.4",</span><br><span class="line">      "10.211.55.5",</span><br><span class="line">      "10.211.55.6",</span><br><span class="line">      "10.211.55.7",</span><br><span class="line">      "10.211.55.10"</span><br><span class="line">    ],</span><br><span class="line">    "key": &#123;</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    "names": [</span><br><span class="line">        &#123;</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "L": "ShenZhen",</span><br><span class="line">            "ST": "ShenZhen",</span><br><span class="line">            "O": "k8s",</span><br><span class="line">            "OU": "System"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建kube-proxy-csr.json文件</span></span><br><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "system:kube-proxy",</span><br><span class="line">  "hosts": [],</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "L": "ShenZhen",</span><br><span class="line">      "ST": "ShenZhen",</span><br><span class="line">      "O": "k8s",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">生成CA证书和私钥</span></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">为apiserver生成自签证书</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes apiserver-csr.json | cfssljson -bare apiserver</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">为kube-proxy生成自签证书</span></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br></pre></td></tr></table></figure>
<h2 id="部署apiserver、controller-manager和scheduler"><a href="#部署apiserver、controller-manager和scheduler" class="headerlink" title="部署apiserver、controller-manager和scheduler"></a>部署apiserver、controller-manager和scheduler</h2><p>二进制包下载地址：<a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/releases</a></p>
<p>在每个release版本的CHANGELOG中有每个版本的二进制包下载列表，下载对应平台下的Server Binaries，上传到其中一台Master节点的/root目录下（本文以1.16.4为例）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建kubernetes工作目录</span></span><br><span class="line">mkdir /opt/kubernetes</span><br><span class="line">mkdir /opt/kubernetes/bin</span><br><span class="line">mkdir /opt/kubernetes/cfg</span><br><span class="line">mkdir /opt/kubernetes/ssl</span><br><span class="line">mkdir /opt/kubernetes/logs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">解压master binaries并拷贝所需的二进制文件到/opt/kubernetes/bin目录下</span></span><br><span class="line">cd /root/</span><br><span class="line">tar zxf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">cp -a /root/kubernetes/server/bin/kube-apiserver /opt/kubernetes/bin/</span><br><span class="line">cp -a /root/kubernetes/server/bin/kube-controller-manager /opt/kubernetes/bin/</span><br><span class="line">cp -a /root/kubernetes/server/bin/kube-scheduler /opt/kubernetes/bin/</span><br><span class="line">cp -a /root/kubernetes/server/bin/kubectl /usr/local/bin/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">拷贝自签证书到/opt/kubernetes/ssl目录下</span></span><br><span class="line">cp -a /root/k8s-cert/&#123;ca,ca-key,apiserver,apiserver-key&#125;.pem /opt/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建kube-apiserver配置文件，标注部分按实际情况进行修改</span></span><br><span class="line">vim /opt/kubernetes/cfg/kube-apiserver.conf</span><br><span class="line">KUBE_APISERVER_OPTS="--logtostderr=false \</span><br><span class="line">--v=2 \</span><br><span class="line">--log-dir=/opt/kubernetes/logs \</span><br><span class="line">--etcd-servers=https://10.211.55.4:2379,https://10.211.55.5:2379,https://10.211.55.6:2379 \</span><br><span class="line">--bind-address=10.211.55.4 \</span><br><span class="line">--secure-port=6443 \</span><br><span class="line">--advertise-address=10.211.55.4 \</span><br><span class="line">--allow-privileged=true \</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \</span><br><span class="line">--authorization-mode=RBAC,Node \</span><br><span class="line">--enable-bootstrap-token-auth=true \</span><br><span class="line">--token-auth-file=/opt/kubernetes/cfg/token.csv \</span><br><span class="line">--service-node-port-range=30000-32767 \</span><br><span class="line">--kubelet-client-certificate=/opt/kubernetes/ssl/apiserver.pem \</span><br><span class="line">--kubelet-client-key=/opt/kubernetes/ssl/apiserver-key.pem \</span><br><span class="line">--tls-cert-file=/opt/kubernetes/ssl/apiserver.pem  \</span><br><span class="line">--tls-private-key-file=/opt/kubernetes/ssl/apiserver-key.pem \</span><br><span class="line">--client-ca-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \</span><br><span class="line">--etcd-cafile=/opt/etcd/ssl/ca.pem \</span><br><span class="line">--etcd-certfile=/opt/etcd/ssl/etcd.pem \</span><br><span class="line">--etcd-keyfile=/opt/etcd/ssl/etcd-key.pem \</span><br><span class="line">--audit-log-maxage=30 \</span><br><span class="line">--audit-log-maxbackup=3 \</span><br><span class="line">--audit-log-maxsize=100 \</span><br><span class="line">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log"</span><br></pre></td></tr></table></figure>
<p><strong>–logtostderr：</strong>日志是否输出到标准错误输出</p>
<p><strong>–v=2：</strong>日志级别0-8，数字越大，日志越详细</p>
<p><strong>–log-dir：</strong>设置日志存放目录</p>
<p><strong>–etcd-servers：</strong>指定etcd服务的URL</p>
<p><strong>–bind-address：</strong>apiserver监听地址</p>
<p><strong>–secure-port：</strong>apiserver监听端口，默认为6443</p>
<p><strong>–advertise-address：</strong>通告地址，让其他节点通过此IP来连接apiserver</p>
<p><strong>–allow-privileged：</strong>开启容器的privileged权限</p>
<p><strong>–service-cluster-ip-range：</strong>Kubernetes集群中Service的虚拟IP地址范围，以CIDR格式表示，例如169.169.0.0/16，该IP范围不能与部署机器的IP地址有重合</p>
<p><strong>–enable-admission-plugins：</strong>Kubernetes集群的准入控制设置，各控制模块以插件的形式依次生效。</p>
<p><strong>–authorization-mode：</strong>授权模式</p>
<p><strong>–enable-bootstrap-token-auth：</strong>启用bootstrap token认证</p>
<p><strong>–service-node-port-range：</strong>Kubernetes集群中Service可使用的端口号范围，默认值为30000～32767</p>
<p><strong>–kubelet-client-certificate、–kubelet-client-key：</strong>连接kubelet使用的证书和私钥</p>
<p><strong>–tls-cert-file、–tls-private-key-file、–client-ca-file、–service-account-key-file：</strong>apiserver启用https所用的证书和私钥</p>
<p><strong>–etcd-cafile、–etcd-certfile、–etcd-keyfile：</strong>连接etcd所使用的证书</p>
<p><strong>–audit-log-maxage、–audit-log-maxbackup、–audit-log-maxsize、–audit-log-path：</strong>日志轮转、日志路径</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建kube-controller-manage配置文件，标注部分按实际情况进行修改</span></span><br><span class="line">vim /opt/kubernetes/cfg/kube-controller-manager.conf</span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS="--logtostderr=false \</span><br><span class="line">--v=2 \</span><br><span class="line">--log-dir=/opt/kubernetes/logs \</span><br><span class="line">--leader-elect=true \</span><br><span class="line">--master=127.0.0.1:8080 \</span><br><span class="line">--address=127.0.0.1 \</span><br><span class="line">--allocate-node-cidrs=true \</span><br><span class="line">--cluster-cidr=10.244.0.0/16 \</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \</span><br><span class="line">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \</span><br><span class="line">--root-ca-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \</span><br><span class="line">--experimental-cluster-signing-duration=876000h0m0s"</span><br></pre></td></tr></table></figure>
<p><strong>–leader-elect：</strong>启用自动选举</p>
<p><strong>–master：</strong>连接apiserver的IP，127.0.0.1:8080是apiserver默认监听的，用于让其他组件通过此地址连接</p>
<p><strong>–address：</strong>配置controller-manager监听地址，不需要对外</p>
<p><strong>–allocate-node-cidrs：</strong>允许安装CNI插件，自动分配IP</p>
<p><strong>–cluster-cidr：</strong>集群pod的IP段，要与与CNI插件的IP段一致</p>
<p><strong>–service-cluster-ip-range：</strong>service cluster IP段，与apiserver中配置保持一致</p>
<p><strong>–cluster-signing-cert-file、–cluster-signing-key-file：</strong>用于集群签名的ca证书和私钥</p>
<p><strong>–root-ca-file、–service-account-private-key-file：</strong>签署service account的证书和私钥</p>
<p><strong>–experimental-cluster-signing-duration：</strong>签发证书的有效期</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建kube-scheduler配置文件，标注部分按实际情况进行修改</span></span><br><span class="line">vim /opt/kubernetes/cfg/kube-scheduler.conf</span><br><span class="line">KUBE_SCHEDULER_OPTS="--logtostderr=false \</span><br><span class="line">--v=2 \</span><br><span class="line">--log-dir=/opt/kubernetes/logs \</span><br><span class="line">--leader-elect \</span><br><span class="line">--master=127.0.0.1:8080 \</span><br><span class="line">--address=127.0.0.1"</span><br></pre></td></tr></table></figure>
<p><strong>–leader-elect：</strong>启用自动选举</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建kube-apiserver的systemd unit文件</span></span><br><span class="line">vim /usr/lib/systemd/system/kube-apiserver.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-apiserver $KUBE_APISERVER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建kube-controller-manager的systemd unit文件</span></span><br><span class="line">vim /usr/lib/systemd/system/kube-controller-manager.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建kube-scheduler的systemd unit文件</span></span><br><span class="line">vim /usr/lib/systemd/system/kube-scheduler.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-scheduler $KUBE_SCHEDULER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>随机生成一个32位字符串，用以创建token.csv文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">token=`head -c 16 /dev/urandom | od -An -t x | tr -d ' '`</span><br><span class="line">echo "$token,kubelet-bootstrap,10001,'system:node-bootstrapper'" &gt; /opt/kubernetes/cfg/token.csv</span><br><span class="line"><span class="meta">#</span><span class="bash">token.csv文件的格式为：(第一列)随机字符串，(第二列)用户名，(第三列)UID，(第四列)用户组</span></span><br></pre></td></tr></table></figure>
<p><strong>注：</strong>此处apiserver配置的token（32位随机字符串）必须要与后面node节点bootstrap.kubeconfig配置里的token一致</p>
<p>设置api-server、controller-manager、scheduler开机自启并启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-apiserver</span><br><span class="line">systemctl enable kube-controller-manager</span><br><span class="line">systemctl enable kube-scheduler</span><br><span class="line">systemctl start kube-apiserver</span><br><span class="line">systemctl start kube-controller-manager</span><br><span class="line">systemctl start kube-scheduler</span><br><span class="line">systemctl status kube-apiserver</span><br><span class="line">systemctl status kube-controller-manager</span><br><span class="line">systemctl status kube-scheduler</span><br></pre></td></tr></table></figure>
<p>在其中一台master上执行如下指令为kubectl TLS Bootstrapping授权</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>
<p>此时你可以通过执行kubectl get cs获取k8s的各服务端组件状态看是否Healthy，但是如果你安装的是1.16版本，你会发现你的输出内容有一些变化，类似如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> kubectl get cs</span></span><br><span class="line">NAME                 AGE</span><br><span class="line">controller-manager   &lt;unknown&gt;</span><br><span class="line">scheduler            &lt;unknown&gt;</span><br><span class="line">etcd-0               &lt;unknown&gt;</span><br><span class="line">etcd-2               &lt;unknown&gt;</span><br><span class="line">etcd-1               &lt;unknown&gt;</span><br></pre></td></tr></table></figure>
<p>起初可能会以为集群部署有问题，但是通过kubectl get cs -o yaml发现status、message等信息都有，只是没有打印出来。所以在网上搜索相关文章，最后在<a href="https://segmentfault.com/a/1190000020912684" target="_blank" rel="noopener">这里</a>找到了原因，原来这是1.16的bug！！！坐等官方修复吧，当然针对此问题，大佬也给出了临时解决办法，参考下方：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs -o=go-template='&#123;&#123;printf "|NAME|STATUS|MESSAGE|\n"&#125;&#125;&#123;&#123;range .items&#125;&#125;&#123;&#123;$name := .metadata.name&#125;&#125;&#123;&#123;range .conditions&#125;&#125;&#123;&#123;printf "|%s|%s|%s|\n" $name .status .message&#125;&#125;&#123;&#123;end&#125;&#125;&#123;&#123;end&#125;&#125;'</span><br></pre></td></tr></table></figure>
<h1 id="部署Node组件"><a href="#部署Node组件" class="headerlink" title="部署Node组件"></a>部署Node组件</h1><hr>
<h2 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h2><p>二进制包下载地址：<a href="https://download.docker.com/linux/static/stable/" target="_blank" rel="noopener">https://download.docker.com/linux/static/stable/</a></p>
<p>到对应平台的目录下载所需版本的Docker二进制包，并上传到Node节点的/root目录下（本文以x86平台下的Docker18.09.9为例）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">解压并拷贝二进制文件到对应目录下</span></span><br><span class="line">cd /root/</span><br><span class="line">tar zxf docker-18.09.9.tgz</span><br><span class="line">cp -a docker/* /usr/bin/</span><br><span class="line">chmod 755 /usr/bin/&#123;containerd,containerd-shim,ctr,docker,dockerd,docker-init,docker-proxy,runc&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建docker的systemd unit文件</span></span><br><span class="line">vim /etc/systemd/system/docker.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TasksMax=infinity</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">设置docker开机自启并启动</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br><span class="line">systemctl status docker</span><br></pre></td></tr></table></figure>
<h2 id="部署kubelet和kube-proxy"><a href="#部署kubelet和kube-proxy" class="headerlink" title="部署kubelet和kube-proxy"></a>部署kubelet和kube-proxy</h2><p>二进制包下载地址：<a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/releases</a></p>
<p>在每个release版本的CHANGELOG中有每个版本的二进制包下载列表，下载对应平台下的Node Binaries，上传到Node节点的/root目录下（本文以1.16.4为例）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建kubernetes工作目录</span></span><br><span class="line">mkdir /opt/kubernetes</span><br><span class="line">mkdir /opt/kubernetes/bin</span><br><span class="line">mkdir /opt/kubernetes/cfg</span><br><span class="line">mkdir /opt/kubernetes/ssl</span><br><span class="line">mkdir /opt/kubernetes/logs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">解压node binaries并拷贝所需的二进制文件到/opt/kubernetes/bin目录下</span></span><br><span class="line">cd /root/</span><br><span class="line">tar zxf kubernetes-node-linux-amd64.tar.gz</span><br><span class="line">cp -a /root/kubernetes/node/bin/kubelet /opt/kubernetes/bin/</span><br><span class="line">cp -a /root/kubernetes/node/bin/kube-proxy /opt/kubernetes/bin/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建kubelet.conf配置文件，标注部分按实际情况进行修改</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--hostname-override：当前节点注册到k8s显示的名称，集群内唯一</span></span><br><span class="line"><span class="meta">#</span><span class="bash">--network-plugin：启用网络插件</span></span><br><span class="line"></span><br><span class="line">vim /opt/kubernetes/cfg/kubelet.conf</span><br><span class="line">KUBELET_OPTS="--logtostderr=false \</span><br><span class="line">--v=2 \</span><br><span class="line">--log-dir=/opt/kubernetes/logs \</span><br><span class="line">--hostname-override=k8s-node1 \</span><br><span class="line">--network-plugin=cni \</span><br><span class="line">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \</span><br><span class="line">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \</span><br><span class="line">--config=/opt/kubernetes/cfg/kubelet-config.yml \</span><br><span class="line">--cert-dir=/opt/kubernetes/ssl"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建bootstrap.kubeconfig配置文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server字段设置master节点的IP地址和端口</span></span><br><span class="line"><span class="meta">#</span><span class="bash">token字段需要与master节点apiserver的token.csv文件中指定的token值一致</span></span><br><span class="line"></span><br><span class="line">vim /opt/kubernetes/cfg/bootstrap.kubeconfig</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority: /opt/kubernetes/ssl/ca.pem</span><br><span class="line">    server: https://10.211.55.4:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubelet-bootstrap</span><br><span class="line">  name: default</span><br><span class="line">current-context: default</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: kubelet-bootstrap</span><br><span class="line">  user:</span><br><span class="line">    token: 65cc0bcbe77f4877f288e5604529f384</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建kubelet-config.yml配置文件，</span></span><br><span class="line">vim /opt/kubernetes/cfg/kubelet-config.yml</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.0.0.2</span><br><span class="line">clusterDomain: cluster.local </span><br><span class="line">failSwapOn: false</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /opt/kubernetes/ssl/ca.pem </span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建kube-proxy.conf配置文件</span></span><br><span class="line">vim /opt/kubernetes/cfg/kube-proxy.conf</span><br><span class="line">KUBE_PROXY_OPTS="--logtostderr=false \</span><br><span class="line">--v=2 \</span><br><span class="line">--log-dir=/opt/kubernetes/logs \</span><br><span class="line">--config=/opt/kubernetes/cfg/kube-proxy-config.yml"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建kube-proxy.kubeconfig配置文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server字段设置master节点的IP地址和端口</span></span><br><span class="line">vim /opt/kubernetes/cfg/kube-proxy.kubeconfig</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority: /opt/kubernetes/ssl/ca.pem</span><br><span class="line">    server: https://10.211.55.4:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kube-proxy</span><br><span class="line">  name: default</span><br><span class="line">current-context: default</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: kube-proxy</span><br><span class="line">  user:</span><br><span class="line">    client-certificate: /opt/kubernetes/ssl/kube-proxy.pem</span><br><span class="line">    client-key: /opt/kubernetes/ssl/kube-proxy-key.pem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建kube-proxy-config.yml配置文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">hostnameOverride字段配置当前节点注册到k8s显示的名称，集群内唯一</span></span><br><span class="line"><span class="meta">#</span><span class="bash">mode字段配置kube-proxy使用的模式，iptables or ipvs</span></span><br><span class="line"></span><br><span class="line">vim /opt/kubernetes/cfg/kube-proxy-config.yml</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">metricsBindAddress: 0.0.0.0:10249</span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig</span><br><span class="line">hostnameOverride: k8s-node1</span><br><span class="line">clusterCIDR: 10.0.0.0/24</span><br><span class="line">mode: ipvs</span><br><span class="line">ipvs:</span><br><span class="line">  scheduler: "rr"</span><br><span class="line">iptables:</span><br><span class="line">  masqueradeAll: true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建kubelet的systemd unit文件</span></span><br><span class="line">vim /usr/lib/systemd/system/kubelet.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line">Before=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kubelet $KUBELET_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建kube-proxy的systemd unit文件</span></span><br><span class="line">vim /usr/lib/systemd/system/kube-proxy.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-proxy $KUBE_PROXY_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>从上面安装了cfssl工具的主机上拷贝ca证书和kube-proxy的自签证书和私钥到Node节点的/opt/kubernetes/ssl目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/k8s-cert/</span><br><span class="line">scp -r ca.pem kube-proxy.pem kube-proxy-key.pem k8s-node1:/opt/kubernetes/ssl/</span><br></pre></td></tr></table></figure>
<p>设置kubelet和kube-proxy开机自启并启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kubelet</span><br><span class="line">systemctl enable kube-proxy</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl start kube-proxy</span><br><span class="line">systemctl status kubelet</span><br><span class="line">systemctl status kube-proxy</span><br></pre></td></tr></table></figure>
<h2 id="允许给Node颁发证书"><a href="#允许给Node颁发证书" class="headerlink" title="允许给Node颁发证书"></a>允许给Node颁发证书</h2><p>当kubelet和kube-proxy成功启动后，此时在master上执行kubectl get csr可以看到有新的节点请求颁发证书(CONDITION字段处于Pending状态)，执行如下指令允许给Node颁发证书</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl certificate approve node-csr-vCjAOsDYkXe4Af4gR-NBikSm4yIG00XV5zLjBZgzmQk</span><br></pre></td></tr></table></figure>
<h2 id="补充知识点"><a href="#补充知识点" class="headerlink" title="补充知识点"></a>补充知识点</h2><ul>
<li><p>若kubectl或kube-proxy配置文件中的hostname-override配置参数漏修改，导致授权后master无法正常获取到Node节点信息，除了修改kubelet.conf的–hostname-override配置和kube-proxy-config.yml的hostnameOverride配置外，还需要将kubelet.kubeconfig文件（这个文件是master认证后客户端自动生成的）删除，才可重新申请授权，否则报错信息类似如下：</p>
<p>  kubelet_node_status.go:94] Unable to register node “k8s-node2” with API server: nodes “k8s-node2” is forbidden: node “k8s-node1” is not allowed to modify node “k8s-node2”</p>
</li>
<li><p>TLS Bootstrapping 机制流程（Kubelet）</p>
</li>
</ul>
<p><img src="https://img.koenli.com/%E5%9C%A8CentOS7%E4%B8%8A%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4_4.png" alt=""></p>
<ul>
<li>如何删除一个Node节点并重新接入集群</li>
</ul>
<p>在Master节点操作</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain 10.211.55.6 --delete-local-data</span><br><span class="line">kubectl delete node 10.211.55.6</span><br></pre></td></tr></table></figure>
<p>在Node节点操作</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /opt/kubernetes/cfg/kubelet.kubeconfig</span><br><span class="line">rm -rf /opt/kubernetes/ssl/kubelet*</span><br><span class="line">systemctl restart kubelet</span><br><span class="line">systemctl restart kube-proxy</span><br></pre></td></tr></table></figure>
<p>在Master节点重新授权</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get csr</span><br><span class="line">kubectl certificate approve xxxx</span><br></pre></td></tr></table></figure>
<h2 id="部署CNI网络"><a href="#部署CNI网络" class="headerlink" title="部署CNI网络"></a>部署CNI网络</h2><p>二进制下载地址：<a href="https://github.com/containernetworking/plugins/releases" target="_blank" rel="noopener">https://github.com/containernetworking/plugins/releases</a></p>
<p>下载所需平台的最新版本的CNI二进制包并上传到node节点的/root目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建cni的工作目录</span></span><br><span class="line">mkdir -p /opt/cni/bin</span><br><span class="line">mkdir -p /etc/cni/net.d</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">解压到对应目录下</span></span><br><span class="line">cd /root/</span><br><span class="line">tar zxf cni-plugins-linux-amd64-v0.8.3.tgz -C /opt/cni/bin/</span><br></pre></td></tr></table></figure>
<p>确保kubelet启用CNI</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /opt/kubernetes/cfg/kubelet.conf |grep network-plugin</span><br><span class="line">--network-plugin=cni \</span><br></pre></td></tr></table></figure>
<p>在任意一台master节点执行如下指令下载网络yaml文件，k8s支持多种网络类型，本文安装的是flannel网络，更多网络类型可参考<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/</span><br><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>
<p>根据实际环境情况修改kube-flannel.yml文件，比如Network、Backend、hostNetwork配置等等，修改完成后进行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/</span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure>
<p>查看flannel的pod创建情况，等待到所有node节点上的flannel pod都处于running状态后表示cni部署完成</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system -o wide</span><br></pre></td></tr></table></figure>
<h2 id="授权apiserver访问kubelet"><a href="#授权apiserver访问kubelet" class="headerlink" title="授权apiserver访问kubelet"></a>授权apiserver访问kubelet</h2><p>为提供安全性，kubelet禁止匿名访问，必须授权才可以。一个常见的表现就是无法通过kubectl logs查看pod的日志，错误输出类似如下：</p>
<pre><code>Error from server (Forbidden): Forbidden (user=kubernetes, verb=get, resource=nodes, subresource=proxy) ( pods/log kube-flannel-ds-amd64-cdmcd)
</code></pre><p>在任意一台master节点上执行如下指令进行授权</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建apiserver-to-kubelet-rbac.yaml文件</span></span><br><span class="line">cat &gt; /root/apiserver-to-kubelet-rbac.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: "true"</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - ""</span><br><span class="line">    resources:</span><br><span class="line">      - nodes/proxy</span><br><span class="line">      - nodes/stats</span><br><span class="line">      - nodes/log</span><br><span class="line">      - nodes/spec</span><br><span class="line">      - nodes/metrics</span><br><span class="line">      - pods/log</span><br><span class="line">    verbs:</span><br><span class="line">      - "*"</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: system:kube-apiserver</span><br><span class="line">  namespace: ""</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:kube-apiserver-to-kubelet</span><br><span class="line">subjects:</span><br><span class="line">  - apiGroup: rbac.authorization.k8s.io</span><br><span class="line">    kind: User</span><br><span class="line">    name: kubernetes</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl apply -f /root/apiserver-to-kubelet-rbac.yaml</span><br></pre></td></tr></table></figure>
<h2 id="环境测试验证"><a href="#环境测试验证" class="headerlink" title="环境测试验证"></a>环境测试验证</h2><p>在任意一个master节点上执行如下指令创建一个nginx pod并暴露端口测试是否可以从外部正常访问</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建nginx deployment</span></span><br><span class="line">kubectl create deployment web --image=nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">暴露端口</span></span><br><span class="line">kubectl expose deployment web --port=80 --type=NodePort</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看对应的访问端口</span></span><br><span class="line">kubectl get service</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">web          NodePort    10.0.0.200   &lt;none&gt;        80:30174/TCP   4s</span><br></pre></td></tr></table></figure>
<p>浏览器访问：http://&lt;Node_IP&gt;:30174若能正常返回nginx欢迎页面，则表示环境一切正常。</p>
<h1 id="部署Web-UI和DNS"><a href="#部署Web-UI和DNS" class="headerlink" title="部署Web UI和DNS"></a>部署Web UI和DNS</h1><hr>
<h2 id="Web-UI"><a href="#Web-UI" class="headerlink" title="Web UI"></a>Web UI</h2><p>Github地址：<a href="https://github.com/kubernetes/dashboard" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard</a><br>官方地址：<a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/</a></p>
<p>在任意一台master节点上下载Web UI的yaml文件到/root目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta6/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure>
<p>编辑recommended.yaml文件，找到kubernetes-dashboard这个Service的部分，设置其type为NodePort，nodePort为30001（可自定义）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">8443</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">30001</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br></pre></td></tr></table></figure>
<p>修改完成后，执行如下指令开始部署Web UI</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /root/recommended.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看kubernetes-dashboard的pod，确认pod的STATUS均为running再继续下面的步骤</span></span><br><span class="line">kubectl get pods -n kubernetes-dashboard</span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">dashboard-metrics-scraper-76585494d8-v4gd9   1/1     Running   0          63s</span><br><span class="line">kubernetes-dashboard-b65488c4-pwkc2          1/1     Running   0          63s</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看对应的service</span></span><br><span class="line">kubectl get service -n kubernetes-dashboard</span><br><span class="line">NAME                        TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard        NodePort    10.0.0.122   &lt;none&gt;        443:30001/TCP   2m45s</span><br></pre></td></tr></table></figure>
<p>创建service account并绑定默认cluster-admin管理员集群角色</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建授权的yaml文件</span></span><br><span class="line">cat &gt; /root/dashboard-adminuser.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">执行授权</span></span><br><span class="line">kubectl apply -f /root/dashboard-adminuser.yaml</span><br></pre></td></tr></table></figure>
<p>获取token</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk '&#123;print $1&#125;')</span><br></pre></td></tr></table></figure>
<p>浏览器访问地址：https://&lt;NODE_IP&gt;:30001</p>
<p>使用上面输出的token登录dashboard，<strong>注意协议一定要用https</strong></p>
<ul>
<li>注：若打开dashboard出现如下页面，没有”继续前往x.x.x.x（不安全）”的选项，则请参考下面的步骤进行处理</li>
</ul>
<p><img src="https://img.koenli.com/%E5%9C%A8CentOS7%E4%B8%8A%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4_5.png" alt=""></p>
<p>出现这个问题主要是因为之前版本部署的时候默认命名空间是kube-system，而新版的是kubernetes-dashboard导致，解决办法如下：</p>
<p>1.在刚执行指令部署Web UI的master节点上执行如下指令删除默认的secret，并用自签证书创建新的secret（注意修改自签证书的路径是否与实际环境一致）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete secret kubernetes-dashboard-certs -n kubernetes-dashboard</span><br><span class="line">kubectl create secret generic kubernetes-dashboard-certs --from-file=/opt/kubernetes/ssl/apiserver-key.pem --from-file=/opt/kubernetes/ssl/apiserver.pem -n kubernetes-dashboard</span><br></pre></td></tr></table></figure>
<p>2.修改/root/recommended.yaml文件，在args下面增加证书两行（搜索auto-generate-certificates即可跳转到对应位置）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">args:</span></span><br><span class="line">  <span class="comment"># PLATFORM-SPECIFIC ARGS HERE</span></span><br><span class="line"><span class="bullet">  -</span> <span class="bullet">--auto-generate-certificates</span></span><br><span class="line"><span class="bullet">  -</span> <span class="bullet">--tls-key-file=apiserver-key.pem</span></span><br><span class="line"><span class="bullet">  -</span> <span class="bullet">--tls-cert-file=apiserver.pem</span></span><br></pre></td></tr></table></figure>
<p>3.重新应用recommended.yaml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /root/recommended.yaml</span><br></pre></td></tr></table></figure>
<p>4.重新访问https://&lt;NODE_IP&gt;:30001，<strong>注意协议一定要用https</strong></p>
<h2 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h2><p>Github地址：<a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns/coredns" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns/coredns</a></p>
<p>部署DNS主要是为了给k8s的Service提供DNS解析服务，使得程序可以通过service的名称进行访问</p>
<ul>
<li>DNS服务监视Kubernetes API，为每一个Service创建DNS记录用于域名解析。</li>
<li>ClusterIP A记录格式：&lt;service-name>.&lt;namespace-name>.svc.cluster.local，示例：my-svc.my-namespace.svc.cluster.local</li>
</ul>
<p>使用kubeadm方式部署的k8s会自动安装CoreDNS，二进制部署方式则需要自行安装</p>
<p>从Github地址上下载coredns.yaml.base文件到任意master节点的/root/目录下，并重命名为coredns.yaml，然后参考下方标注修改其中的部分参数</p>
<ul>
<li>__MACHINE_GENERATED_WARNING__替换为This is a file generated from the base underscore template file: coredns.yaml.base</li>
<li>__PILLAR__DNS__DOMAIN__替换为cluster.local,一般不修改，若要修改记得要与node节点上kubelet-config.yml文件中的clusterDomain的值一致，并要调整api-server证书中的hosts字段值并重新生产证书</li>
<li>__PILLAR__DNS__MEMORY__LIMIT__替换为170Mi，此内存限制的值可根据实际环境资源进行调整</li>
<li>__PILLAR__DNS__SERVER__替换为10.0.0.2，此IP地址需要与Node节点上/opt/kubernetes/cfg/kubelet-config.yml文件中配置的clusterDNS字段的IP一致</li>
</ul>
<p>以下为我替换后最终的文件内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is a file generated from the base underscore template file: coredns.yaml.base</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">      <span class="string">kubernetes.io/cluster-service:</span> <span class="string">"true"</span></span><br><span class="line">      <span class="string">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">kubernetes.io/bootstrapping:</span> <span class="string">rbac-defaults</span></span><br><span class="line">    <span class="string">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:coredns</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">endpoints</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">services</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">namespaces</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">- apiGroups:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nodes</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">rbac.authorization.kubernetes.io/autoupdate:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">kubernetes.io/bootstrapping:</span> <span class="string">rbac-defaults</span></span><br><span class="line">    <span class="string">addonmanager.kubernetes.io/mode:</span> <span class="string">EnsureExists</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:coredns</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="attr">system:coredns</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">      <span class="string">addonmanager.kubernetes.io/mode:</span> <span class="string">EnsureExists</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  Corefile:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    .:53 &#123;</span></span><br><span class="line"><span class="string">        errors</span></span><br><span class="line"><span class="string">        health &#123;</span></span><br><span class="line"><span class="string">            lameduck 5s</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        ready</span></span><br><span class="line"><span class="string">        kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span></span><br><span class="line"><span class="string">            pods insecure</span></span><br><span class="line"><span class="string">            fallthrough in-addr.arpa ip6.arpa</span></span><br><span class="line"><span class="string">            ttl 30</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        prometheus :9153</span></span><br><span class="line"><span class="string">        forward . /etc/resolv.conf</span></span><br><span class="line"><span class="string">        cache 30</span></span><br><span class="line"><span class="string">        loop</span></span><br><span class="line"><span class="string">        reload</span></span><br><span class="line"><span class="string">        loadbalance</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">    <span class="string">kubernetes.io/cluster-service:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="string">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line">    <span class="string">kubernetes.io/name:</span> <span class="string">"CoreDNS"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># replicas: not specified here:</span></span><br><span class="line">  <span class="comment"># 1. In order to make Addon Manager do not reconcile this replicas parameter.</span></span><br><span class="line">  <span class="comment"># 2. Default is 1.</span></span><br><span class="line">  <span class="comment"># 3. Will be tuned in real time if DNS horizontal auto-scaling is turned on.</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="attr">    rollingUpdate:</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line">        <span class="string">seccomp.security.alpha.kubernetes.io/pod:</span> <span class="string">'runtime/default'</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">        - key:</span> <span class="string">"CriticalAddonsOnly"</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">"Exists"</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line">        <span class="string">beta.kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">k8s.gcr.io/coredns:1.6.5</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">170</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">100</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">70</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        args:</span> <span class="string">[</span> <span class="string">"-conf"</span><span class="string">,</span> <span class="string">"/etc/coredns/Corefile"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">config-volume</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/coredns</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">dns</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">UDP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">dns-tcp</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">9153</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">metrics</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/health</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">          successThreshold:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          failureThreshold:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/ready</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">8181</span></span><br><span class="line"><span class="attr">            scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">        securityContext:</span></span><br><span class="line"><span class="attr">          allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">          capabilities:</span></span><br><span class="line"><span class="attr">            add:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">NET_BIND_SERVICE</span></span><br><span class="line"><span class="attr">            drop:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">all</span></span><br><span class="line"><span class="attr">          readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      dnsPolicy:</span> <span class="string">Default</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">config-volume</span></span><br><span class="line"><span class="attr">          configMap:</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">coredns</span></span><br><span class="line"><span class="attr">            items:</span></span><br><span class="line"><span class="attr">            - key:</span> <span class="string">Corefile</span></span><br><span class="line"><span class="attr">              path:</span> <span class="string">Corefile</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-dns</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">prometheus.io/port:</span> <span class="string">"9153"</span></span><br><span class="line">    <span class="string">prometheus.io/scrape:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">    <span class="string">kubernetes.io/cluster-service:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="string">addonmanager.kubernetes.io/mode:</span> <span class="string">Reconcile</span></span><br><span class="line">    <span class="string">kubernetes.io/name:</span> <span class="string">"CoreDNS"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line"><span class="attr">  clusterIP:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">dns</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">UDP</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">dns-tcp</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">metrics</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">9153</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>
<p>执行如下指令进行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /root/coredns.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">确认dns相关的pod均为running状态</span></span><br><span class="line">kubectl get pod -n kube-system</span><br></pre></td></tr></table></figure>
<ul>
<li>测试验证</li>
</ul>
<p>在任意master节点上执行如下指令创建一个busybox容器，在容器中ping service的名称看是否可以正常解析到IP地址并通信正常，如果可以则说明DNS服务部署成功。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /root/bs.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata: </span><br><span class="line">    name: busybox</span><br><span class="line">    namespace: default</span><br><span class="line">spec:</span><br><span class="line">    containers:</span><br><span class="line">      - image: busybox:1.28.4</span><br><span class="line">        command:</span><br><span class="line">          - sleep</span><br><span class="line">          - "3600"</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: busybox</span><br><span class="line">    restartPolicy: Always</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f /root/bs.yaml</span><br><span class="line">kubectl get pods</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">待pod处于running状态后运行如下指令进入容器中</span></span><br><span class="line">kubectl exec -ti busybox sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">在容器中执行如下指令若出现类似输出则说明解析正常</span></span><br><span class="line">/ # nslookup kubernetes</span><br><span class="line">Server:    10.0.0.2</span><br><span class="line">Address 1: 10.0.0.2 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes</span><br><span class="line">Address 1: 10.0.0.1 kubernetes.default.svc.cluster.local</span><br><span class="line">/ # ping kubernetes</span><br><span class="line">PING kubernetes (10.0.0.1): 56 data bytes</span><br><span class="line">64 bytes from 10.0.0.1: seq=0 ttl=64 time=0.042 ms</span><br><span class="line">64 bytes from 10.0.0.1: seq=1 ttl=64 time=0.129 ms</span><br><span class="line">^C</span><br><span class="line">--- kubernetes ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.042/0.085/0.129 ms</span><br></pre></td></tr></table></figure>
<p>到目前为止一套单Master+2个Node的K8S集群全部搭建完成，但是Master存在单点故障，因此在实际生产环境，我们需要部署多个Master节点，并在Master之前增加一层负载均衡（可通过Nginx、LVS、HAproxy实现），同时为了避免负载均衡存在单点故障，通过Keepalived来实现负载均衡的主备，这样就能保证整个集群不存在单点故障，所有组件均有高可用。</p>
<p>接下来我们将扩容一台Master节点，并通过Nginx和Keepalived实现高可用的负载均衡。</p>
<h1 id="Master高可用"><a href="#Master高可用" class="headerlink" title="Master高可用"></a>Master高可用</h1><hr>
<h2 id="部署Master组件（同Master1一致）"><a href="#部署Master组件（同Master1一致）" class="headerlink" title="部署Master组件（同Master1一致）"></a>部署Master组件（同Master1一致）</h2><p><strong>注</strong>新Master节点的系统初始化操作请参考之前章节进行，此处不再赘述</p>
<p>将Master1上的kubernetes工作目录、etc工作目录下的ssl目录（证书和私钥文件）、Master组件的systemd unit文件和kubectl二进制文件拷贝到新增Master节点的对应目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scp -r /opt/kubernetes/ k8s-master2:/opt/</span><br><span class="line">ssh k8s-master2 rm -rf /opt/kubernetes/logs/*</span><br><span class="line">ssh k8s-master2 mkdir /opt/etcd</span><br><span class="line">scp -r /opt/etcd/ssl/ k8s-master2:/opt/etcd/</span><br><span class="line">scp -r /usr/lib/systemd/system/&#123;kube-apiserver,kube-controller-manager,kube-scheduler&#125;.service k8s-master2:/usr/lib/systemd/system/</span><br><span class="line">scp -r /usr/local/bin/kubectl k8s-master2:/usr/local/bin/</span><br></pre></td></tr></table></figure>
<p>修改新Master节点上apiserver配置文件中的–bind-address和–advertise-address参数为本机IP</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/kubernetes/cfg/kube-apiserver.conf</span><br><span class="line">KUBE_APISERVER_OPTS="--logtostderr=false \</span><br><span class="line">--v=2 \</span><br><span class="line">--log-dir=/opt/kubernetes/logs \</span><br><span class="line">--etcd-servers=https://10.211.55.4:2379,https://10.211.55.5:2379,https://10.211.55.6:2379 \</span><br><span class="line">--bind-address=10.211.55.7 \</span><br><span class="line">--secure-port=6443 \</span><br><span class="line">--advertise-address=10.211.55.7 \</span><br><span class="line">--allow-privileged=true \</span><br><span class="line">--service-cluster-ip-range=10.0.0.0/24 \</span><br><span class="line">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \</span><br><span class="line">--authorization-mode=RBAC,Node \</span><br><span class="line">--enable-bootstrap-token-auth=true \</span><br><span class="line">--token-auth-file=/opt/kubernetes/cfg/token.csv \</span><br><span class="line">--service-node-port-range=30000-32767 \</span><br><span class="line">--kubelet-client-certificate=/opt/kubernetes/ssl/apiserver.pem \</span><br><span class="line">--kubelet-client-key=/opt/kubernetes/ssl/apiserver-key.pem \</span><br><span class="line">--tls-cert-file=/opt/kubernetes/ssl/apiserver.pem  \</span><br><span class="line">--tls-private-key-file=/opt/kubernetes/ssl/apiserver-key.pem \</span><br><span class="line">--client-ca-file=/opt/kubernetes/ssl/ca.pem \</span><br><span class="line">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \</span><br><span class="line">--etcd-cafile=/opt/etcd/ssl/ca.pem \</span><br><span class="line">--etcd-certfile=/opt/etcd/ssl/etcd.pem \</span><br><span class="line">--etcd-keyfile=/opt/etcd/ssl/etcd-key.pem \</span><br><span class="line">--audit-log-maxage=30 \</span><br><span class="line">--audit-log-maxbackup=3 \</span><br><span class="line">--audit-log-maxsize=100 \</span><br><span class="line">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log"</span><br></pre></td></tr></table></figure>
<p>设置api-server、controller-manager、scheduler开机自启并启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-apiserver</span><br><span class="line">systemctl enable kube-controller-manager</span><br><span class="line">systemctl enable kube-scheduler</span><br><span class="line">systemctl start kube-apiserver</span><br><span class="line">systemctl start kube-controller-manager</span><br><span class="line">systemctl start kube-scheduler</span><br><span class="line">systemctl status kube-apiserver</span><br><span class="line">systemctl status kube-controller-manager</span><br><span class="line">systemctl status kube-scheduler</span><br></pre></td></tr></table></figure>
<p>在新Master节点上执行如下指令若能正常获取到node节点信息说明新Master节点新增成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>
<h2 id="部署Nginx负载均衡"><a href="#部署Nginx负载均衡" class="headerlink" title="部署Nginx负载均衡"></a>部署Nginx负载均衡</h2><p>Nginx RPM下载地址：<a href="http://nginx.org/packages/rhel/7/x86_64/RPMS/" target="_blank" rel="noopener">http://nginx.org/packages/rhel/7/x86_64/RPMS/</a></p>
<p>下载Nginx安装包并上传到规划部署Nginx的机器的/root目录下，并进行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/</span><br><span class="line">rpm -ivh nginx-1.16.1-1.el7.ngx.x86_64.rpm</span><br></pre></td></tr></table></figure>
<p>配置Nginx配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/nginx.conf</span><br><span class="line">......</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">新增如下stream部分</span></span><br><span class="line"><span class="meta">#</span><span class="bash">upstream中依此列出所有master节点的IP:Port</span></span><br><span class="line"><span class="meta">#</span><span class="bash">listen字段如果Nginx是和apiserver部署在同一台服务器上，需要使用非6443端口（本文使用8443），否则会产生端口冲突，若不是部署在同一台机器上则可以使用默认6443端口</span></span><br><span class="line">stream &#123;</span><br><span class="line"></span><br><span class="line">    log_format  main  '$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent';</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/k8s-access.log  main;</span><br><span class="line"></span><br><span class="line">    upstream k8s-apiserver &#123;</span><br><span class="line">                server 10.211.55.4:6443;</span><br><span class="line">                server 10.211.55.7:6443;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">       listen 8443;</span><br><span class="line">       proxy_pass k8s-apiserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>设置Nginx开机自启并启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable nginx</span><br><span class="line">systemctl start nginx</span><br><span class="line">systemctl status nginx</span><br></pre></td></tr></table></figure>
<h2 id="部署Keepalived"><a href="#部署Keepalived" class="headerlink" title="部署Keepalived"></a>部署Keepalived</h2><h3 id="主节点"><a href="#主节点" class="headerlink" title="主节点"></a>主节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">yum install keepalived -y</span><br><span class="line">cp -a /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">配置keepalived配置文件</span></span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen@firewall.loc</span><br><span class="line">     failover@firewall.loc</span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id NGINX_MASTER</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">    script "/etc/keepalived/check_nginx.sh"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0    # 接口名称</span><br><span class="line">    virtual_router_id 51    # VRRP 路由 ID实例，每个实例是唯一的</span><br><span class="line">    priority 100    # 优先级，备服务器设置 90</span><br><span class="line">    advert_int 1    # 指定VRRP 心跳包通告间隔时间，默认1秒</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.211.55.10/24</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_nginx</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建Nginx检测脚本</span></span><br><span class="line">vim /etc/keepalived/check_nginx.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">count=$(ps -ef |grep nginx |egrep -cv "grep|$$")</span><br><span class="line"></span><br><span class="line">if [ "$count" -eq 0 ];then</span><br><span class="line">    exit 1</span><br><span class="line">else</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">授予Nginx检测脚本可执行权限</span></span><br><span class="line">chmod +x /etc/keepalived/check_nginx.sh</span><br></pre></td></tr></table></figure>
<p>设置Keepalived开机自启并启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable keepalived</span><br><span class="line">systemctl start keepalived</span><br><span class="line">systemctl status keepalived</span><br></pre></td></tr></table></figure>
<h3 id="备节点"><a href="#备节点" class="headerlink" title="备节点"></a>备节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">yum install keepalived -y</span><br><span class="line">cp -a /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">配置keepalived配置文件</span></span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">global_defs &#123; </span><br><span class="line">   notification_email &#123; </span><br><span class="line">     acassen@firewall.loc </span><br><span class="line">     failover@firewall.loc </span><br><span class="line">     sysadmin@firewall.loc </span><br><span class="line">   &#125; </span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc  </span><br><span class="line">   smtp_server 127.0.0.1 </span><br><span class="line">   smtp_connect_timeout 30 </span><br><span class="line">   router_id NGINX_BACKUP</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">    script "/etc/keepalived/check_nginx.sh"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123; </span><br><span class="line">    state BACKUP </span><br><span class="line">    interface eth0    # 接口名称</span><br><span class="line">    virtual_router_id 51    # VRRP 路由 ID实例，每个实例是唯一的 </span><br><span class="line">    priority 90    # 优先级，备服务器设置 90 </span><br><span class="line">    advert_int 1    # 指定VRRP 心跳包通告间隔时间，默认1秒 </span><br><span class="line">    authentication &#123; </span><br><span class="line">        auth_type PASS      </span><br><span class="line">        auth_pass 1111 </span><br><span class="line">    &#125;  </span><br><span class="line">    virtual_ipaddress &#123; </span><br><span class="line">        10.211.55.10/24</span><br><span class="line">    &#125; </span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_nginx</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建Nginx检测脚本</span></span><br><span class="line">vim /etc/keepalived/check_nginx.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">count=$(ps -ef |grep nginx |egrep -cv "grep|$$")</span><br><span class="line"></span><br><span class="line">if [ "$count" -eq 0 ];then</span><br><span class="line">    exit 1</span><br><span class="line">else</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">授予Nginx检测脚本可执行权限</span></span><br><span class="line">chmod +x /etc/keepalived/check_nginx.sh</span><br></pre></td></tr></table></figure>
<p>设置Keepalived开机自启并启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable keepalived</span><br><span class="line">systemctl start keepalived</span><br><span class="line">systemctl status keepalived</span><br></pre></td></tr></table></figure>
<h2 id="修改Node连接VIP"><a href="#修改Node连接VIP" class="headerlink" title="修改Node连接VIP"></a>修改Node连接VIP</h2><p>修改所有node节点上k8s的bootstrap.kubeconfig、kubelet.kubeconfig和kube-proxy.kubeconfig配置文件中的server字段的IP和Port信息，IP替换为VIP、Port替换为Nginx中配置的监听端口，然后重启kubelet和kube-proxy服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sed -i &quot;s/10.211.55.4:6443/10.211.55.10:8443/g&quot; /opt/kubernetes/cfg/*</span><br><span class="line">systemctl restart kubelet</span><br><span class="line">systemctl restart kube-proxy</span><br><span class="line"></span><br><span class="line">#确认node节点是否处于Ready状态</span><br><span class="line">kubectl  get nodes</span><br></pre></td></tr></table></figure>
<h2 id="测试VIP是否正常工作"><a href="#测试VIP是否正常工作" class="headerlink" title="测试VIP是否正常工作"></a>测试VIP是否正常工作</h2><p>在任意节点上执行如下指令调用API看是否可以正常查看版本信息。其中token替换为token.csv中的token值，IP替换为VIP，Port替换为Nginx中配置的监听端口</p>
<p>若VIP可以正常工作，可以尝试关闭其中一台Nginx，确认VIP是否可以正常漂移到backup节点，然后再次测试调用API是否正常，验证是否可以达到故障切换的效果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl -k --header "Authorization: Bearer 65cc0bcbe77f4877f288e5604529f384" https://10.211.55.10:8443/version</span><br><span class="line"><span class="meta">#</span><span class="bash">返回类似如下输出一切正常</span></span><br><span class="line">&#123;</span><br><span class="line">  "major": "1",</span><br><span class="line">  "minor": "16",</span><br><span class="line">  "gitVersion": "v1.16.4",</span><br><span class="line">  "gitCommit": "224be7bdce5a9dd0c2fd0d46b83865648e2fe0ba",</span><br><span class="line">  "gitTreeState": "clean",</span><br><span class="line">  "buildDate": "2019-12-11T12:37:43Z",</span><br><span class="line">  "goVersion": "go1.12.12",</span><br><span class="line">  "compiler": "gc",</span><br><span class="line">  "platform": "linux/amd64"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此一套高可用架构的Kubernetes集群就部署完成了，架构图如下所示。若还需要再安装Helm、ingress-nginx、配置k8s对接外部存储做持久化存储，比如Ceph，可继续参考如下内容。</p>
<p><img src="https://img.koenli.com/%E5%9C%A8CentOS7%E4%B8%8A%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2Kubernetes%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4_6.png" alt=""></p>
<h1 id="安装helm"><a href="#安装helm" class="headerlink" title="安装helm"></a>安装helm</h1><hr>
<p>helm官网：<a href="https://helm.sh/" target="_blank" rel="noopener">https://helm.sh/</a></p>
<p>helm github：<a href="https://github.com/helm/helm" target="_blank" rel="noopener">https://github.com/helm/helm</a></p>
<p>下载所需版本的helm安装包（本文以2.16.1版本为例），上传到所有的master节点的/root/helm目录下(若没有此目录先创建)，执行如下指令安装helm客户端</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /root/helm</span><br><span class="line">tar zxf helm-v2.16.1-linux-amd64.tar.gz</span><br><span class="line">cd linux-amd64/</span><br><span class="line">cp -a helm  /usr/local/bin/</span><br></pre></td></tr></table></figure>
<p>在其中一台master运行如下指令安装helm服务端</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm init</span><br></pre></td></tr></table></figure>
<p>执行如下指令设置tiller的rbac权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount -n kube-system tiller</span><br><span class="line">kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span><br><span class="line">kubectl --namespace kube-system patch deploy tiller-deploy -p '&#123;"spec":&#123;"template":&#123;"spec":&#123;"serviceAccount":"tiller"&#125;&#125;&#125;&#125;'</span><br><span class="line">helm init --upgrade --service-account tiller</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">稍等片刻待tiller的pod处于均Ready后执行helm list看是否可以正常列出所有的release</span></span><br><span class="line">kubectl get pods -n kube-system  |grep tiller</span><br><span class="line">helm list</span><br><span class="line">helm version</span><br></pre></td></tr></table></figure>
<p>若执行helm version出现类似如下报错</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Client: &amp;version.Version&#123;SemVer:"v2.16.1", GitCommit:"bbdfe5e7803a12bbdf97e94cd847859890cf4050", GitTreeState:"clean"&#125;</span><br><span class="line">E1213 15:58:40.605638   10274 portforward.go:400] an error occurred forwarding 34583 -&gt; 44134: error forwarding port 44134 to pod 1e92153b279110f9464193c4ea7d6314ac69e70ce60e7319df9443e379b52ed4, uid : unable to do port forwarding: socat not found</span><br></pre></td></tr></table></figure>
<p>解决办法：</p>
<p>在所有node节点上安装socat</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install socat -y</span><br></pre></td></tr></table></figure>
<h1 id="安装ingress-nginx"><a href="#安装ingress-nginx" class="headerlink" title="安装ingress-nginx"></a>安装ingress-nginx</h1><hr>
<p>ingress-nginx官网：<a href="https://kubernetes.github.io/ingress-nginx/" target="_blank" rel="noopener">https://kubernetes.github.io/ingress-nginx/</a></p>
<p>ingress-nginx github：<a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">https://github.com/kubernetes/ingress-nginx</a></p>
<p>在任意一台master节点上下载ingress-nginx的yaml文件到/root目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml</span><br></pre></td></tr></table></figure>
<p>编辑mandatory.yaml文件，设置ingress-nginx的部署模式，本文采用hostNetwork模式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-ingress-controller</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="string">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line">      <span class="string">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">      <span class="string">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line">        <span class="string">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">        <span class="string">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line">        <span class="string">prometheus.io/port:</span> <span class="string">"10254"</span></span><br><span class="line">        <span class="string">prometheus.io/scrape:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span>    <span class="comment">#添加此行设置ingress-nginx的部署模式为hostNetwork</span></span><br><span class="line">      <span class="comment"># wait up to five minutes for the drain of connections</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">nginx-ingress-serviceaccount</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line">        <span class="string">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>运行如下指令安装ingress-nginx</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /root/</span><br><span class="line">kubectl apply -f mandatory.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">确认ingress-nginx的pod是否正常启动，处于running状态</span></span><br><span class="line">kubectl get pods -n ingress-nginx</span><br></pre></td></tr></table></figure>
<h1 id="配置rbd-provisioner"><a href="#配置rbd-provisioner" class="headerlink" title="配置rbd-provisioner"></a>配置rbd-provisioner</h1><hr>
<p><strong>K8S要对接Ceph RBD存储做持久化存储，首先必须要搭建Ceph存储集群，并在K8S的所有节点上安装对应版本的ceph-common客户端命令。关于Ceph集群的搭建和ceph-common此处不进行赘述，可参考<a href="https://docs.ceph.com/docs/master/" target="_blank" rel="noopener">Ceph官网文档</a>进行。</strong></p>
<p>Ceph集群和ceph-common安装都完成后，在其中一台master上创建/root/rbd-provisioner目录下，并执行如下指令创建rbd-provisioner所需的yaml文件，标注部分根据实际情况进行修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/rbd-provisioner</span><br><span class="line">cd /root/rbd-provisioner</span><br><span class="line"></span><br><span class="line">cat &gt; clusterrole.yaml &lt;&lt; EOF</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["persistentvolumes"]</span><br><span class="line">    verbs: ["get", "list", "watch", "create", "delete"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["persistentvolumeclaims"]</span><br><span class="line">    verbs: ["get", "list", "watch", "update"]</span><br><span class="line">  - apiGroups: ["storage.k8s.io"]</span><br><span class="line">    resources: ["storageclasses"]</span><br><span class="line">    verbs: ["get", "list", "watch"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["events"]</span><br><span class="line">    verbs: ["create", "update", "patch"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["services"]</span><br><span class="line">    resourceNames: ["kube-dns","coredns"]</span><br><span class="line">    verbs: ["list", "get"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["endpoints"]</span><br><span class="line">    verbs: ["get", "list", "watch", "create", "update", "patch"]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; clusterrolebinding.yaml &lt;&lt; EOF</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: rbd-provisioner</span><br><span class="line">    namespace: ceph</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; deployment.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: rbd-provisioner</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: rbd-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: rbd-provisioner</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        image: "quay.io/external_storage/rbd-provisioner:latest"</span><br><span class="line">        env:</span><br><span class="line">        - name: PROVISIONER_NAME</span><br><span class="line">          value: ceph.com/rbd</span><br><span class="line">      serviceAccount: rbd-provisioner</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; role.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [""]</span><br><span class="line">  resources: ["secrets"]</span><br><span class="line">  verbs: ["get"]</span><br><span class="line">- apiGroups: [""]</span><br><span class="line">  resources: ["endpoints"]</span><br><span class="line">  verbs: ["get", "list", "watch", "create", "update", "patch"]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; rolebinding.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; serviceaccount.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; storageclass.yaml &lt;&lt; EOF</span><br><span class="line">kind: StorageClass</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    storageclass.beta.kubernetes.io/is-default-class: "true"</span><br><span class="line">  name: rbd</span><br><span class="line">provisioner: ceph.com/rbd</span><br><span class="line">parameters:</span><br><span class="line">  monitors: 10.211.55.4:6789,10.211.55.5:6789,10.211.55.6:6789    #配置Ceph集群的monitor节点信息</span><br><span class="line">  pool: k8s    #配置要连接的pool，若没有需要先在ceph集群上创建</span><br><span class="line">  adminId: admin</span><br><span class="line">  adminSecretNamespace: ceph</span><br><span class="line">  adminSecretName: ceph-secret</span><br><span class="line">  fsType: ext4</span><br><span class="line">  userId: admin</span><br><span class="line">  userSecretNamespace: ceph</span><br><span class="line">  userSecretName: ceph-secret</span><br><span class="line">  imageFormat: "2"</span><br><span class="line">  imageFeatures: layering</span><br><span class="line">reclaimPolicy: Delete</span><br><span class="line">volumeBindingMode: Immediate</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; secrets.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: ceph-secret</span><br><span class="line">  namespace: ceph</span><br><span class="line">type: "ceph.com/rbd"</span><br><span class="line">data:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> ceph auth add client.kube mon <span class="string">'allow r'</span> osd <span class="string">'allow rwx pool=kube'</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> ceph auth get-key client.admin | base64</span></span><br><span class="line">  key: QVFEcTN5VmRvK28xRHhBQUlKNW5zQ0xwcTd3N0Q5OTJENm9YeGc9PQ==    #配置Ceph集群的kering，此处填的是经过base64编码后的值</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>执行如下执行创建rbd storageclass</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /root/rbd-provisioner</span><br><span class="line">kubectl create namespace ceph</span><br><span class="line">kubectl apply -f storageclass.yaml -f clusterrolebinding.yaml -f clusterrole.yaml -f deployment.yaml -f rolebinding.yaml -f role.yaml -f secrets.yaml -f serviceaccount.yaml</span><br><span class="line">kubectl get pods -n ceph | grep rbd-provisioner</span><br></pre></td></tr></table></figure>
<h1 id="配置cephfs-provisioner"><a href="#配置cephfs-provisioner" class="headerlink" title="配置cephfs-provisioner"></a>配置cephfs-provisioner</h1><hr>
<p><strong>K8S要对接CephFS存储做持久化存储，首先必须要搭建Ceph存储集群，并在K8S的所有节点上安装对应版本的ceph-common客户端命令。关于Ceph集群的搭建和ceph-common此处不进行赘述，可参考<a href="https://docs.ceph.com/docs/master/" target="_blank" rel="noopener">Ceph官网文档</a>进行。</strong></p>
<p>Ceph集群和ceph-common安装都完成后，在其中一台master上创建/root/cephfs-provisioner目录下，并执行如下指令创建cephfs-provisioner所需的yaml文件，标注部分根据实际情况进行修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/cephfs-provisioner</span><br><span class="line">cd /root/cephfs-provisioner</span><br><span class="line"></span><br><span class="line">cat &gt; clusterrole.yaml &lt;&lt; EOF</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["persistentvolumes"]</span><br><span class="line">    verbs: ["get", "list", "watch", "create", "delete"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["persistentvolumeclaims"]</span><br><span class="line">    verbs: ["get", "list", "watch", "update"]</span><br><span class="line">  - apiGroups: ["storage.k8s.io"]</span><br><span class="line">    resources: ["storageclasses"]</span><br><span class="line">    verbs: ["get", "list", "watch"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["events"]</span><br><span class="line">    verbs: ["create", "update", "patch"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["services"]</span><br><span class="line">    resourceNames: ["kube-dns","coredns"]</span><br><span class="line">    verbs: ["list", "get"]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; clusterrolebinding.yaml &lt;&lt; EOF</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: cephfs-provisioner</span><br><span class="line">    namespace: ceph</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; deployment.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: cephfs-provisioner</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: cephfs-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: cephfs-provisioner</span><br><span class="line">        image: "quay.io/external_storage/cephfs-provisioner:latest"</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        env:</span><br><span class="line">        - name: PROVISIONER_NAME</span><br><span class="line">          value: ceph.com/cephfs</span><br><span class="line">        - name: PROVISIONER_SECRET_NAMESPACE</span><br><span class="line">          value: ceph</span><br><span class="line">        command:</span><br><span class="line">        - "/usr/local/bin/cephfs-provisioner"</span><br><span class="line">        args:</span><br><span class="line">        - "-id=cephfs-provisioner-1"</span><br><span class="line">        - "-disable-ceph-namespace-isolation=true"</span><br><span class="line">        - "-enable-quota=true"</span><br><span class="line">      serviceAccount: cephfs-provisioner</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; role.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["secrets"]</span><br><span class="line">    verbs: ["create", "get", "delete"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["endpoints"]</span><br><span class="line">    verbs: ["get", "list", "watch", "create", "update", "patch"]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; rolebinding.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat  &gt; serviceaccount.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; storageclass.yaml &lt;&lt; EOF</span><br><span class="line">kind: StorageClass</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: cephfs</span><br><span class="line">provisioner: ceph.com/cephfs</span><br><span class="line">parameters:</span><br><span class="line">    monitors: 10.211.55.4:6789,10.211.55.5:6789,10.211.55.6:6789    #配置Ceph集群的monitor节点信息</span><br><span class="line">    adminId: admin</span><br><span class="line">    adminSecretName: ceph-secret</span><br><span class="line">    adminSecretNamespace: "ceph"</span><br><span class="line">reclaimPolicy: Delete</span><br><span class="line">volumeBindingMode: Immediate</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>执行如下指令创建cephfs storageclass</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /root/cephfs-provisioner</span><br><span class="line">kubectl apply -f storageclass.yaml -f clusterrolebinding.yaml -f clusterrole.yaml -f deployment.yaml -f rolebinding.yaml -f role.yaml -f serviceaccount.yaml</span><br><span class="line">kubectl get pods -n ceph | grep cephfs-provisioner</span><br></pre></td></tr></table></figure>
<p>参考链接：</p>
<p><a href="https://blog.csdn.net/snipercai/article/details/101012124" target="_blank" rel="noopener">https://blog.csdn.net/snipercai/article/details/101012124</a></p>
<p><a href="https://segmentfault.com/a/1190000020912684" target="_blank" rel="noopener">https://segmentfault.com/a/1190000020912684</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Docker/" rel="tag"># Docker</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/a5819beb.html" rel="prev" title="CentOS/RedHat下Postfix邮件服务器搭建">
      <i class="fa fa-chevron-left"></i> CentOS/RedHat下Postfix邮件服务器搭建
    </a></div>
      <div class="post-nav-item">
    <a href="/13e99bd8.html" rel="next" title="在CentOS7上使用kubeadm快速部署Kubernetes高可用集群">
      在CentOS7上使用kubeadm快速部署Kubernetes高可用集群 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
    <div>
        
        <div>
    
        <div class="end-slogan" style="text-align:center;font-size:13px;letter-spacing:10px;user-select:none;color:#bbb;"><br/>本文结束啦<i class="fa fa-star"></i>感谢您阅读<br/><br/></div>
    
</div> 

        
     </div>
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubernetes是什么"><span class="nav-number">1.</span> <span class="nav-text">Kubernetes是什么</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubernetes特性"><span class="nav-number">2.</span> <span class="nav-text">Kubernetes特性</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubernetes集群架构与组件"><span class="nav-number">3.</span> <span class="nav-text">Kubernetes集群架构与组件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Master组件"><span class="nav-number">3.1.</span> <span class="nav-text">Master组件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Node组件"><span class="nav-number">3.2.</span> <span class="nav-text">Node组件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubernetes核心概念"><span class="nav-number">4.</span> <span class="nav-text">Kubernetes核心概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Pod"><span class="nav-number">4.1.</span> <span class="nav-text">Pod</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Controllers"><span class="nav-number">4.2.</span> <span class="nav-text">Controllers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Service"><span class="nav-number">4.3.</span> <span class="nav-text">Service</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Label"><span class="nav-number">4.4.</span> <span class="nav-text">Label</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Namespace"><span class="nav-number">4.5.</span> <span class="nav-text">Namespace</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#生产环境K8S平台规划"><span class="nav-number">5.</span> <span class="nav-text">生产环境K8S平台规划</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#单Master集群"><span class="nav-number">5.1.</span> <span class="nav-text">单Master集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多Master集群-HA"><span class="nav-number">5.2.</span> <span class="nav-text">多Master集群(HA)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#服务器硬件配置推荐"><span class="nav-number">6.</span> <span class="nav-text">服务器硬件配置推荐</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Mater节点"><span class="nav-number">6.1.</span> <span class="nav-text">Mater节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Node节点"><span class="nav-number">6.2.</span> <span class="nav-text">Node节点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实验环境信息"><span class="nav-number">7.</span> <span class="nav-text">实验环境信息</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#系统初始化"><span class="nav-number">8.</span> <span class="nav-text">系统初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#关闭防火墙"><span class="nav-number">8.1.</span> <span class="nav-text">关闭防火墙</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关闭selinux"><span class="nav-number">8.2.</span> <span class="nav-text">关闭selinux</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关闭swap"><span class="nav-number">8.3.</span> <span class="nav-text">关闭swap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置主机名"><span class="nav-number">8.4.</span> <span class="nav-text">配置主机名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加所有节点的本地host解析"><span class="nav-number">8.5.</span> <span class="nav-text">添加所有节点的本地host解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装基础软件包"><span class="nav-number">8.6.</span> <span class="nav-text">安装基础软件包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内核开启网络支持"><span class="nav-number">8.7.</span> <span class="nav-text">内核开启网络支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置所有master到所有节点（包括自身）的ssh免密登录"><span class="nav-number">8.8.</span> <span class="nav-text">配置所有master到所有节点（包括自身）的ssh免密登录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#节点之间时间同步"><span class="nav-number">8.9.</span> <span class="nav-text">节点之间时间同步</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#server端"><span class="nav-number">8.9.1.</span> <span class="nav-text">server端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#client端"><span class="nav-number">8.9.2.</span> <span class="nav-text">client端</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装CFSSL工具"><span class="nav-number">9.</span> <span class="nav-text">安装CFSSL工具</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署etcd数据库集群"><span class="nav-number">10.</span> <span class="nav-text">部署etcd数据库集群</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用cfssl为etcd生成自签证书"><span class="nav-number">10.1.</span> <span class="nav-text">使用cfssl为etcd生成自签证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署etcd3-4之前版本"><span class="nav-number">10.2.</span> <span class="nav-text">部署etcd3.4之前版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署etcd3-4版本"><span class="nav-number">10.3.</span> <span class="nav-text">部署etcd3.4版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#卸载etcd"><span class="nav-number">10.4.</span> <span class="nav-text">卸载etcd</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署Master组件"><span class="nav-number">11.</span> <span class="nav-text">部署Master组件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用cfssl为apiserver和kube-proxy生成自签证书"><span class="nav-number">11.1.</span> <span class="nav-text">使用cfssl为apiserver和kube-proxy生成自签证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署apiserver、controller-manager和scheduler"><span class="nav-number">11.2.</span> <span class="nav-text">部署apiserver、controller-manager和scheduler</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署Node组件"><span class="nav-number">12.</span> <span class="nav-text">部署Node组件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装Docker"><span class="nav-number">12.1.</span> <span class="nav-text">安装Docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署kubelet和kube-proxy"><span class="nav-number">12.2.</span> <span class="nav-text">部署kubelet和kube-proxy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#允许给Node颁发证书"><span class="nav-number">12.3.</span> <span class="nav-text">允许给Node颁发证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#补充知识点"><span class="nav-number">12.4.</span> <span class="nav-text">补充知识点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署CNI网络"><span class="nav-number">12.5.</span> <span class="nav-text">部署CNI网络</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#授权apiserver访问kubelet"><span class="nav-number">12.6.</span> <span class="nav-text">授权apiserver访问kubelet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#环境测试验证"><span class="nav-number">12.7.</span> <span class="nav-text">环境测试验证</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署Web-UI和DNS"><span class="nav-number">13.</span> <span class="nav-text">部署Web UI和DNS</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Web-UI"><span class="nav-number">13.1.</span> <span class="nav-text">Web UI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DNS"><span class="nav-number">13.2.</span> <span class="nav-text">DNS</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Master高可用"><span class="nav-number">14.</span> <span class="nav-text">Master高可用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#部署Master组件（同Master1一致）"><span class="nav-number">14.1.</span> <span class="nav-text">部署Master组件（同Master1一致）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署Nginx负载均衡"><span class="nav-number">14.2.</span> <span class="nav-text">部署Nginx负载均衡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署Keepalived"><span class="nav-number">14.3.</span> <span class="nav-text">部署Keepalived</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#主节点"><span class="nav-number">14.3.1.</span> <span class="nav-text">主节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#备节点"><span class="nav-number">14.3.2.</span> <span class="nav-text">备节点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改Node连接VIP"><span class="nav-number">14.4.</span> <span class="nav-text">修改Node连接VIP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试VIP是否正常工作"><span class="nav-number">14.5.</span> <span class="nav-text">测试VIP是否正常工作</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装helm"><span class="nav-number">15.</span> <span class="nav-text">安装helm</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装ingress-nginx"><span class="nav-number">16.</span> <span class="nav-text">安装ingress-nginx</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置rbd-provisioner"><span class="nav-number">17.</span> <span class="nav-text">配置rbd-provisioner</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置cephfs-provisioner"><span class="nav-number">18.</span> <span class="nav-text">配置cephfs-provisioner</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Koenli"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Koenli</p>
  <div class="site-description" itemprop="description">讨厌自己明明不甘平凡，却又不好好努力</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">39</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

      <!-- 添加canvas粒子时钟 -->
      
        
      
      <div style="">
  <canvas id="canvas" style="width:60%;">当前浏览器不支持canvas，请更换浏览器后再试</canvas>
</div>
<script>
(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //声明canvas的宽高
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //存储时间数据
    var data = [];
    //存储运动的小球
    var balls = [];
    //设置粒子半径
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //存储时间数字，由十位小时、个位小时、冒号、十位分钟、个位分钟、冒号、十位秒钟、个位秒钟这7个数字组成
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*生成点阵数字*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*更新时钟*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //时间发生变化
            if(NewData[i] !== data[i]){
                //将变化的数字值和在data数组中的索引存储在changeNumArray数组中
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //增加小球
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*更新小球状态*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*增加要运动的小球*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*渲染*/
    function render(){
        //重置画布宽度，达到清空画布的效果
        canvas.height = 100;
        //渲染时钟
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //渲染小球
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //更新时钟
        updateDigitTime();
        //更新小球状态
        updateBalls();
        //渲染
        render();
    },50);
}

})();
</script>



    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="beian"><a href="http://www.beian.miit.gov.cn" rel="noopener" target="_blank">粤ICP备 </a>
      <img src="http://www.beian.gov.cn/portal/download" style="display: inline-block;"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=18126773" rel="noopener" target="_blank">18126773号 </a>
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Koenli</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.7.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.2
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : 'XD8aPBomWwb9OrD5OlP3F42U-gzGzoHsz',
      appKey     : 'EHcp6RUK4G6BGD0dqfrz0IDo',
      placeholder: "ヾﾉ≧∀≦)o来啊，快活啊!",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>
<div class="moon-menu">
  <div class="moon-menu-items">
    
    <div class="moon-menu-item" onclick="back2bottom()">
      <i class="fa fa-chevron-down"></i>
    </div>
    
    <div class="moon-menu-item" onclick="back2top()">
      <i class="fa fa-chevron-up"></i>
    </div>
    
  </div>
  <div class="moon-menu-button" onclick="moonMenuClick()">
    <svg class="moon-menu-svg">
      <circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle>
      <circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle>
      <g class="moon-menu-points">
        <circle class="moon-menu-point" r=".2rem" cx="0" cy="-.8rem"></circle>
        <circle class="moon-menu-point" r=".2rem"></circle>
        <circle class="moon-menu-point" r=".2rem" cx="0" cy=".8rem"></circle>
      </g>
    </svg>
    <div class="moon-menu-icon">
    </div>
    <div class="moon-menu-text">
    </div>
  </div>
</div>

<script>

  const moonMenuListener = function () {

    //Get scroll percent
    let offsetHeight = document.documentElement.offsetHeight;
    let scrollHeight = document.documentElement.scrollHeight;
    var scrollTop = document.documentElement.scrollTop || window.pageYOffset || document.body.scrollTop;
    let percent = Math.round(scrollTop / (scrollHeight - offsetHeight) * 100);
    if (percent > 100) percent = 100;

    let menuText = document.querySelector('.moon-menu-text');
    let menuPoints = document.querySelector('.moon-menu-points');
    if (!percent) {
      percent = 0;
      menuText.style.display = 'none';
      menuPoints.style.display = 'block';
    } else {
      menuText.style.display = 'block';
      menuPoints.style.display = 'none';
      menuText.innerHTML = percent + '%';
    }

    //Update strokeDasharray
    let length = 196;
    document.querySelector('.moon-menu-border').style.strokeDasharray = percent * length / 100 + ' ' + length;

  }

  window.addEventListener('load', () => {
    moonMenuListener();
  });
  window.addEventListener('scroll', moonMenuListener);

  const moonMenuClick = function () {
    let items = document.querySelector('.moon-menu-items')
    items.classList.toggle('active');
    let points = document.querySelectorAll('.moon-menu-point');
    let childItems = document.querySelectorAll('.moon-menu-item');
    if (items.classList.contains('active')) {
      points[0].setAttribute("cx", "-.8rem");
      points[0].setAttribute("cy", "0");
      points[2].setAttribute("cx", ".8rem");
      points[2].setAttribute("cy", "0");
      for (let i = 0; i < childItems.length; i++) {
        childItems[i].style.top = -3 - 3 * i + 'rem';
        childItems[i].style.opacity = .9;
      }
    } else {
      points[0].setAttribute("cx", "0");
      points[0].setAttribute("cy", "-.8rem");
      points[2].setAttribute("cx", "0");
      points[2].setAttribute("cy", ".8rem");
      for (let i = 0; i < childItems.length; i++) {
        childItems[i].style.top = '1rem';
        childItems[i].style.opacity = 0;
      }
    }
  };

  const back2top = () => {
    window.scroll({ top: 0, behavior: 'smooth' });
  }

  const back2bottom = () => {
    let offsetHeight = document.documentElement.offsetHeight;
    let scrollHeight = document.documentElement.scrollHeight;
    window.scroll({ top: (scrollHeight - offsetHeight), behavior: 'smooth' });
  }

</script>
</body>
</html>
<!--添加点击礼花特效-->
<script type="text/javascript" src="/js/clickfireworks.js"></script>
<!--添加评论输入礼花特效-->
<script src="/js/activate-power-mode.js"></script>
<script>
  POWERMODE.colorful = true; // 控制开启 / 开启礼花特效 
  POWERMODE.shake = false; // 控制开启 / 关闭屏幕震动特效
  document.body.addEventListener('input', POWERMODE);
</script>
