<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.7.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.koenli.com","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="环境要求 Mater节点 物理机虚拟机均可，至少1台，高可用集群至少2台（etcd集群必须奇数台）  配置推荐：实验环境2核2G、测试环境2核4G、生产环境8核16G  关闭所有swap分区或不划分swap分区">
<meta name="keywords" content="Docker">
<meta property="og:type" content="article">
<meta property="og:title" content="在CentOS7上使用kubeadm快速部署Kubernetes高可用集群">
<meta property="og:url" content="http://www.koenli.com/13e99bd8.html">
<meta property="og:site_name" content="Koenli&#39;s Blog">
<meta property="og:description" content="环境要求 Mater节点 物理机虚拟机均可，至少1台，高可用集群至少2台（etcd集群必须奇数台）  配置推荐：实验环境2核2G、测试环境2核4G、生产环境8核16G  关闭所有swap分区或不划分swap分区">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-03-01T13:48:51.349Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="在CentOS7上使用kubeadm快速部署Kubernetes高可用集群">
<meta name="twitter:description" content="环境要求 Mater节点 物理机虚拟机均可，至少1台，高可用集群至少2台（etcd集群必须奇数台）  配置推荐：实验环境2核2G、测试环境2核4G、生产环境8核16G  关闭所有swap分区或不划分swap分区">

<link rel="canonical" href="http://www.koenli.com/13e99bd8.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>在CentOS7上使用kubeadm快速部署Kubernetes高可用集群 | Koenli's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Koenli's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">19</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">39</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.koenli.com/13e99bd8.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Koenli">
      <meta itemprop="description" content="讨厌自己明明不甘平凡，却又不好好努力">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Koenli's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          在CentOS7上使用kubeadm快速部署Kubernetes高可用集群
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-09 19:24:53" itemprop="dateCreated datePublished" datetime="2019-12-09T19:24:53+08:00">2019-12-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-01 21:48:51" itemprop="dateModified" datetime="2020-03-01T21:48:51+08:00">2020-03-01</time>
              </span>

          
            <span id="/13e99bd8.html" class="post-meta-item leancloud_visitors" data-flag-title="在CentOS7上使用kubeadm快速部署Kubernetes高可用集群" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/13e99bd8.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/13e99bd8.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h1><hr>
<h2 id="Mater节点"><a href="#Mater节点" class="headerlink" title="Mater节点"></a>Mater节点</h2><ul>
<li><p>物理机虚拟机均可，至少1台，高可用集群至少2台（etcd集群必须奇数台）</p>
</li>
<li><p>配置推荐：实验环境2核2G、测试环境2核4G、生产环境8核16G</p>
</li>
<li><p>关闭所有swap分区或不划分swap分区</p>
</li>
</ul>
<a id="more"></a>
<h2 id="Node节点"><a href="#Node节点" class="headerlink" title="Node节点"></a>Node节点</h2><ul>
<li><p>物理机虚拟机均可，大于等于1台</p>
</li>
<li><p>配置推荐：实验环境2核2G、测试环境4核8G、生产环境16核64G</p>
</li>
<li><p>关闭所有swap分区或不划分swap分区</p>
</li>
</ul>
<h1 id="操作系统版本"><a href="#操作系统版本" class="headerlink" title="操作系统版本"></a>操作系统版本</h1><hr>
<p>CentOS7.5及以上</p>
<h1 id="实验环境信息"><a href="#实验环境信息" class="headerlink" title="实验环境信息"></a>实验环境信息</h1><hr>
<table>
<thead>
<tr>
<th style="text-align:center">主机名</th>
<th style="text-align:center">配置</th>
<th style="text-align:center">操作系统</th>
<th style="text-align:center">IP地址</th>
<th style="text-align:center">角色</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">k8s-master1</td>
<td style="text-align:center">2核2G</td>
<td style="text-align:center">CentOS7.5</td>
<td style="text-align:center">10.211.55.4</td>
<td style="text-align:center">master,node</td>
</tr>
<tr>
<td style="text-align:center">k8s-master2</td>
<td style="text-align:center">2核2G</td>
<td style="text-align:center">CentOS7.5</td>
<td style="text-align:center">10.211.55.5</td>
<td style="text-align:center">master,node</td>
</tr>
<tr>
<td style="text-align:center">k8s-master3</td>
<td style="text-align:center">2核2G</td>
<td style="text-align:center">CentOS7.5</td>
<td style="text-align:center">10.211.55.6</td>
<td style="text-align:center">master,node</td>
</tr>
</tbody>
</table>
<p>VIP:10.211.55.10</p>
<h1 id="系统初始化"><a href="#系统初始化" class="headerlink" title="系统初始化"></a>系统初始化</h1><hr>
<h2 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure>
<h2 id="关闭selinux"><a href="#关闭selinux" class="headerlink" title="关闭selinux"></a>关闭selinux</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">sed -i "s/^SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config</span><br></pre></td></tr></table></figure>
<h2 id="关闭swap"><a href="#关闭swap" class="headerlink" title="关闭swap"></a>关闭swap</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br><span class="line">echo 'swapoff -a ' &gt;&gt; /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure>
<h2 id="配置主机名"><a href="#配置主机名" class="headerlink" title="配置主机名"></a>配置主机名</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname &lt;hostname&gt;</span><br></pre></td></tr></table></figure>
<h2 id="添加所有节点的本地host解析"><a href="#添加所有节点的本地host解析" class="headerlink" title="添加所有节点的本地host解析"></a>添加所有节点的本地host解析</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">x.x.x.x hostname1</span><br><span class="line">y.y.y.y hostname2</span><br><span class="line">...</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="安装基础软件包"><a href="#安装基础软件包" class="headerlink" title="安装基础软件包"></a>安装基础软件包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install vim net-tools lrzsz unzip dos2unix telnet sysstat iotop pciutils lsof tcpdump psmisc bc wget socat -y</span><br></pre></td></tr></table></figure>
<h2 id="内核开启网络支持"><a href="#内核开启网络支持" class="headerlink" title="内核开启网络支持"></a>内核开启网络支持</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.ipv4.ip_nonlocal_bind = 1</span><br><span class="line">EOF</span><br><span class="line">modprobe br_netfilter</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>
<h2 id="配置所有Master到所有节点（包括自身）的ssh免密登录"><a href="#配置所有Master到所有节点（包括自身）的ssh免密登录" class="headerlink" title="配置所有Master到所有节点（包括自身）的ssh免密登录"></a>配置所有Master到所有节点（包括自身）的ssh免密登录</h2><p>依此在所有的master节点上做如下操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub k8s-master1</span><br></pre></td></tr></table></figure>
<h2 id="节点之间时间同步"><a href="#节点之间时间同步" class="headerlink" title="节点之间时间同步"></a>节点之间时间同步</h2><h3 id="Server端"><a href="#Server端" class="headerlink" title="Server端"></a>Server端</h3><p><strong>注：</strong>如果环境可以访问互联网，可以不需要自己搭建server端，参考后面的client端部分设置所有节点与公网ntp时间服务器(例如time1.cloud.tencent.com)同步时间即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装chrony并备份配置文件</span></span><br><span class="line">yum install chrony ntpdate -y</span><br><span class="line">cp -a /etc/chrony.conf /etc/chrony.conf.bak</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">修改server端配置文件如下，标注的地方需要修改</span></span><br><span class="line">cat &gt; /etc/chrony.conf &lt;&lt; EOF</span><br><span class="line">stratumweight 0</span><br><span class="line">driftfile /var/lib/chrony/drift</span><br><span class="line">rtcsync</span><br><span class="line">makestep 10 3</span><br><span class="line">allow 10.211.55.0/24    #设置为实际环境客户端所属IP网段</span><br><span class="line">smoothtime 400 0.01</span><br><span class="line"> </span><br><span class="line">bindcmdaddress 127.0.0.1</span><br><span class="line">bindcmdaddress ::1</span><br><span class="line"> </span><br><span class="line">local stratum 8</span><br><span class="line">manual</span><br><span class="line">keyfile /etc/chrony.keys</span><br><span class="line"><span class="meta">#</span><span class="bash">initstepslew 10 client1 client3 client6</span></span><br><span class="line">noclientlog</span><br><span class="line">logchange 0.5</span><br><span class="line">logdir /var/log/chrony</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">启动服务，设置开机自启</span></span><br><span class="line">systemctl restart chronyd.service</span><br><span class="line">systemctl enable  chronyd.service</span><br><span class="line">systemctl status chronyd.service</span><br></pre></td></tr></table></figure>
<h3 id="Client端"><a href="#Client端" class="headerlink" title="Client端"></a>Client端</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装chrony并备份配置文件</span></span><br><span class="line">yum install chrony ntpdate -y</span><br><span class="line">cp -a /etc/chrony.conf /etc/chrony.conf.bak</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">修改client端配置文件</span></span><br><span class="line">sed -i "s%^server%#server%g" /etc/chrony.conf</span><br><span class="line">echo "server 10.211.55.4 iburst" &gt;&gt; /etc/chrony.conf    #添加一行，其中的IP地址替换为实际环境server端的IP地址</span><br><span class="line"></span><br><span class="line">ntpdate  10.211.55.4    #手动同步一次时间，其中的IP地址替换为实际环境server端的IP地址</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">启动服务，设置开机自启</span></span><br><span class="line">systemctl restart chronyd.service</span><br><span class="line">systemctl enable  chronyd.service</span><br><span class="line">systemctl status chronyd.service</span><br><span class="line"></span><br><span class="line">chronyc  sources    #查看ntp_servers状态</span><br><span class="line">chronyc  tracking    #查看ntp详细信息</span><br></pre></td></tr></table></figure>
<h1 id="所有节点（Master和Node）安装docker"><a href="#所有节点（Master和Node）安装docker" class="headerlink" title="所有节点（Master和Node）安装docker"></a>所有节点（Master和Node）安装docker</h1><hr>
<h2 id="卸载旧版本的Docker"><a href="#卸载旧版本的Docker" class="headerlink" title="卸载旧版本的Docker"></a>卸载旧版本的Docker</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-engine</span><br></pre></td></tr></table></figure>
<h2 id="配置docker-ce-repository"><a href="#配置docker-ce-repository" class="headerlink" title="配置docker-ce repository"></a>配置docker-ce repository</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装所需要的包，yum-utils提供了yum-config-manager工具，device-mapper-persistent-data和lvm2是设备映射存储驱动所需要的</span></span><br><span class="line">yum install -y yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">设置稳定版的repo仓库</span></span><br><span class="line">yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>
<h2 id="安装docker-ce"><a href="#安装docker-ce" class="headerlink" title="安装docker-ce"></a>安装docker-ce</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装最新版本的docker-ce</span></span><br><span class="line">yum install docker-ce docker-ce-cli containerd.io -y</span><br></pre></td></tr></table></figure>
<p><strong>注：</strong>若要安装指定版本的docker，按照如下步骤：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">列出repo仓库中可用的docker版本并降序排列</span></span><br><span class="line">yum list docker-ce --showduplicates | sort -r</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">确认好要安装的版本，例如为18.09.9，则替换yum install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.io -y中的&lt;VERSION_STRING&gt;进行安装</span></span><br><span class="line">例如：yum install docker-ce-18.09.9 docker-ce-cli-18.09.9 containerd.io -y</span><br></pre></td></tr></table></figure>
<h2 id="启动Docker并设置开机自启"><a href="#启动Docker并设置开机自启" class="headerlink" title="启动Docker并设置开机自启"></a>启动Docker并设置开机自启</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br><span class="line">systemctl status docker</span><br></pre></td></tr></table></figure>
<h1 id="所有节点（Master和Node）安装kubeadm、kubelet和kubectl"><a href="#所有节点（Master和Node）安装kubeadm、kubelet和kubectl" class="headerlink" title="所有节点（Master和Node）安装kubeadm、kubelet和kubectl"></a>所有节点（Master和Node）安装kubeadm、kubelet和kubectl</h1><hr>
<ul>
<li><p><strong>Kubelet：</strong>负责与其他节点集群通信，并进行本节点Pod和容器生命周期的管理。</p>
</li>
<li><p><strong>Kubeadm：</strong>Kubernetes的自动化部署工具，降低了部署难度，提高效率。</p>
</li>
<li><p><strong>Kubectl：</strong>Kubernetes集群管理工具。</p>
</li>
</ul>
<h2 id="配置kubernetes-repository"><a href="#配置kubernetes-repository" class="headerlink" title="配置kubernetes repository"></a>配置kubernetes repository</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><strong>注：</strong>若无法访问国外网站，可配置国内的kubernetes源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="关闭selinux-1"><a href="#关闭selinux-1" class="headerlink" title="关闭selinux"></a>关闭selinux</h2><p>关闭selinux主要是为了允许容器访问主机文件系统，在kubelet对SELINUX的支持改进前需要先关闭selinux，由于在前期准备中已做，此步可忽略</p>
<h2 id="打开net-bridge-bridge-nf-call-iptables内核参数"><a href="#打开net-bridge-bridge-nf-call-iptables内核参数" class="headerlink" title="打开net.bridge.bridge-nf-call-iptables内核参数"></a>打开net.bridge.bridge-nf-call-iptables内核参数</h2><p>配置net.bridge.bridge-nf-call-iptables内核参数为1，不开启的话可能出现流量绕过iptables而导致流量路由错误的问题，由于在前期准备中已做，此步可忽略</p>
<h2 id="安装kubeadm、kubelet和kubectl"><a href="#安装kubeadm、kubelet和kubectl" class="headerlink" title="安装kubeadm、kubelet和kubectl"></a>安装kubeadm、kubelet和kubectl</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装最新版本的kubelet、kubeadm、kubectl</span></span><br><span class="line">yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span><br><span class="line">systemctl enable --now kubelet</span><br><span class="line"><span class="meta">#</span><span class="bash">kubelet现在每隔几秒钟就重新启动一次，因为它在一个crashloop中等待kubeadm告诉它该做什么</span></span><br></pre></td></tr></table></figure>
<p><strong>注：</strong>若要安装指定版本的kubelet、kubeadm、kubectl，可参考如下步骤：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装1.14.6版本的kubelet、kubeadm、kubectl</span></span><br><span class="line">yum install -y kubelet-1.14.6 kubeadm-1.14.6 kubectl-1.14.6 --disableexcludes=kubernetes</span><br><span class="line">systemctl enable --now kubelet</span><br><span class="line"><span class="meta">#</span><span class="bash">kubelet现在每隔几秒钟就重新启动一次，因为它在一个crashloop中等待kubeadm告诉它该做什么</span></span><br></pre></td></tr></table></figure>
<h1 id="所有的Master上配置Keepalived和HAProxy（单Master节点部署忽略此步）"><a href="#所有的Master上配置Keepalived和HAProxy（单Master节点部署忽略此步）" class="headerlink" title="所有的Master上配置Keepalived和HAProxy（单Master节点部署忽略此步）"></a>所有的Master上配置Keepalived和HAProxy（单Master节点部署忽略此步）</h1><hr>
<h2 id="Keepalived"><a href="#Keepalived" class="headerlink" title="Keepalived"></a>Keepalived</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装keeplived并备份配置文件</span></span><br><span class="line">yum install -y keepalived</span><br><span class="line">cp -a /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">修改keepalived配置文件如下，标注的地方需要修改</span></span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"> </span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id k8s-master1 #标识，可用机器主机名作为标识</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER             #设置角色，第一个master为MASTER，剩余的节点均为BACKUP</span><br><span class="line">    interface eth0           #设置vip绑定端口</span><br><span class="line">    virtual_router_id 51     #让master和backup在同一个虚拟路由里，id号必须相同</span><br><span class="line">    priority 150             #优先级,谁的优先级高谁就是master，值越大优先级越高</span><br><span class="line">    advert_int 1             #心跳间隔时间</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS       #认证</span><br><span class="line">        auth_pass k8s        #密码</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.211.55.10      #虚拟ip</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">启动keepalived并设置开机自启</span></span><br><span class="line">systemctl restart keepalived.service</span><br><span class="line">systemctl enable keepalived.service</span><br><span class="line">systemctl status keepalived.service</span><br></pre></td></tr></table></figure>
<h2 id="HAProxy"><a href="#HAProxy" class="headerlink" title="HAProxy"></a>HAProxy</h2><p><strong>注：</strong>所有master节点上haproxy配置文件都是一样的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装haproxy并备份配置文件</span></span><br><span class="line">yum install -y haproxy</span><br><span class="line">cp -a /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">修改haproxy配置文件如下，标注的地方需要修改</span></span><br><span class="line">cat &gt; /etc/haproxy/haproxy.cfg &lt;&lt; EOF</span><br><span class="line">global</span><br><span class="line">        chroot  /var/lib/haproxy</span><br><span class="line">        daemon</span><br><span class="line">        group haproxy</span><br><span class="line">        user haproxy</span><br><span class="line">        log 127.0.0.1:514 local0 warning</span><br><span class="line">        pidfile /var/lib/haproxy.pid</span><br><span class="line">        maxconn 20000</span><br><span class="line">        spread-checks 3</span><br><span class="line">        nbproc 8</span><br><span class="line">defaults</span><br><span class="line">        log     global</span><br><span class="line">        mode    tcp</span><br><span class="line">        retries 3</span><br><span class="line">        option redispatch</span><br><span class="line">listen k8s-apiserver</span><br><span class="line">        bind 0.0.0.0:8443   # 指定绑定的IP和端口，端口建议用非6443端口（此处用8443），因为如果haproxy是和k8s apiserver部署在同一台服务器上，用6443会产生端口冲突，若不是部署在同一台机器上则此处端口可以使用6443</span><br><span class="line">        mode tcp</span><br><span class="line">        balance roundrobin</span><br><span class="line">        timeout server 15s</span><br><span class="line">        timeout connect 15s</span><br><span class="line">        server k8sapiserver1 10.211.55.4:6443 check port 6443 inter 5000 fall 5 #转发到k8s-master1的apiserver上，apiserver端口默认是6443</span><br><span class="line">        server k8sapiserver2 10.211.55.5:6443 check port 6443 inter 5000 fall 5 #转发到k8s-master2的apiserver上，apiserver端口默认是6443</span><br><span class="line">        server k8sapiserver3 10.211.55.6:6443 check port 6443 inter 5000 fall 5 #转发到k8s-master3的apiserver上，apiserver端口默认是6443</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">启动haproxy并设置开机自启</span></span><br><span class="line">systemctl restart haproxy </span><br><span class="line">systemctl enable haproxy</span><br><span class="line">systemctl status haproxy</span><br></pre></td></tr></table></figure>
<h1 id="初始化第一台Master"><a href="#初始化第一台Master" class="headerlink" title="初始化第一台Master"></a>初始化第一台Master</h1><hr>
<h2 id="新版本kubeadm"><a href="#新版本kubeadm" class="headerlink" title="新版本kubeadm"></a>新版本kubeadm</h2><h3 id="初始化第一个master"><a href="#初始化第一个master" class="headerlink" title="初始化第一个master"></a>初始化第一个master</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init \</span><br><span class="line">--apiserver-advertise-address=10.211.55.4 \</span><br><span class="line">--kubernetes-version v1.16.4 \</span><br><span class="line">--service-cidr=10.1.0.0/16 \</span><br><span class="line">--pod-network-cidr=10.244.0.0/16 \</span><br><span class="line">--control-plane-endpoint 10.211.55.10:8443 \</span><br><span class="line">--upload-certs</span><br></pre></td></tr></table></figure>
<p><strong>参数描述:</strong></p>
<p><strong>-–apiserver-advertise-address：</strong>指定kube-apiserver监听的ip地址,就是master本机IP地址。</p>
<p><strong>-–kubernetes-version：</strong>指定k8s版本；</p>
<p><strong>-–service-cidr：</strong>指定SVC的网络范围，注意不要与服务器的网络范围重叠；</p>
<p><strong>-–pod-network-cidr：</strong>指定Pod的网络范围，默认为10.244.0.0/16，安装网络时yaml文件中指定的网络范围要与此参数设置的一致;</p>
<p><strong>-–control-plane-endpoint：</strong>单Master部署时配置为Master节点IP，端口为6443；多Master部署时指定keepalived的虚拟ip和端口</p>
<p><strong>-–upload-certs：</strong>上传证书</p>
<p>初始化成功后，会看到大概如下提示，下面信息先保留，后续添加master节点和node节点需要用到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of control-plane nodes by copying certificate authorities</span><br><span class="line">and service account keys on each node and then running the following as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join 10.211.55.10:6443 --token y55nex.s699ytnwr28o1vu1 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:dd0932f4d17a864cf4ea3a7eff44c77695b47f39de03eaaf1dfd27762d7dd48b \</span><br><span class="line">    --control-plane --certificate-key b2ef4609c5af0d51334d49b20a3713e073ef818593d830b5b17ac58b294cc5c0</span><br><span class="line"></span><br><span class="line">Please note that the certificate-key gives access to cluster sensitive data, keep it secret!</span><br><span class="line">As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use kubeadm init phase upload-certs to reload certs afterward.</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 10.211.55.10:6443 --token y55nex.s699ytnwr28o1vu1 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:dd0932f4d17a864cf4ea3a7eff44c77695b47f39de03eaaf1dfd27762d7dd48b</span><br></pre></td></tr></table></figure>
<h3 id="配置kubectl的config文件"><a href="#配置kubectl的config文件" class="headerlink" title="配置kubectl的config文件"></a>配置kubectl的config文件</h3><p>kubectl默认会在执行的用户家目录下面的.kube目录下寻找config文件。按照上面输出的提示执行如下指令将在初始化时[kubeconfig]步骤生成的admin.conf拷贝到.kube/config，因为此配置文件中记录了apiserver的访问地址，所以后面直接执行kubectl命令就可以正常连接到APIServer中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>
<p>此时使用kubectl  get node能看到第一个master节点还处于NotReady状态，这是因为现在还没安装网络</p>
<h3 id="安装网络"><a href="#安装网络" class="headerlink" title="安装网络"></a>安装网络</h3><p>在任意一台master节点执行如下指令下载网络yaml文件，k8s支持多种网络类型，本文安装的是flannel网络，更多网络类型可参考<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/</span><br><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>
<p>根据实际环境情况修改kube-flannel.yml文件，比如Network、Backend、hostNetwork配置等等，Network配置的网络范围要与kubeadm init时指定的-–pod-network-cidr一致，修改完成后进行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/</span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure>
<p>查看flannel的pod创建情况，等待到所有node节点上的flannel pod都处于running状态后表示cni部署完成</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system -o wide</span><br></pre></td></tr></table></figure>
<h2 id="旧版本kubeadm"><a href="#旧版本kubeadm" class="headerlink" title="旧版本kubeadm"></a>旧版本kubeadm</h2><h3 id="修改初始化配置文件"><a href="#修改初始化配置文件" class="headerlink" title="修改初始化配置文件"></a>修改初始化配置文件</h3><p><strong>注：</strong>由于之前版本的kubeadm(例如1.14.6)不支持–control-plane-endpoint参数，不能像上面那样通过kubeadm init直接初始化第一个master，需要先通过如下指令导出默认配置，然后在根据自己的实际环境修改配置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config print init-defaults &gt; kubeadm-init.yml</span><br></pre></td></tr></table></figure>
<p>编辑kubeadm-init.yml，标注的地方需要修改或增加</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">bootstrapTokens:</span></span><br><span class="line"><span class="attr">- groups:</span></span><br><span class="line"><span class="attr">  - system:</span><span class="attr">bootstrappers:kubeadm:default-node-token</span></span><br><span class="line"><span class="attr">  token:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line"><span class="attr">  ttl:</span> <span class="number">24</span><span class="string">h0m0s</span>    <span class="comment">####token有效期，添加节点如果token过期需要重新生成</span></span><br><span class="line"><span class="attr">  usages:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">signing</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">authentication</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line"><span class="attr">  advertiseAddress:</span> <span class="number">10.211</span><span class="number">.55</span><span class="number">.4</span>    <span class="comment">#填写本地真实IP</span></span><br><span class="line"><span class="attr">  bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line"><span class="attr">  criSocket:</span> <span class="string">/var/run/dockershim.sock</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">k8s-master1</span>    <span class="comment">#填写本地主机名</span></span><br><span class="line"><span class="attr">  taints:</span></span><br><span class="line"><span class="attr">  - effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">    key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line"><span class="attr">  timeoutForControlPlane:</span> <span class="number">4</span><span class="string">m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controlPlaneEndpoint:</span> <span class="string">"10.211.55.10:8443"</span>    <span class="comment">#单master节点时这里写“本地真实IP:6443”；多master节点时写“VIP:端口”，端口要与haproxy配置中的bind字段的端口一致</span></span><br><span class="line"><span class="attr">controllerManager:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">CoreDNS</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line"><span class="attr">  local:</span></span><br><span class="line"><span class="attr">    dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">k8s.gcr.io</span>    <span class="comment">#如果无法访问国外网址，可将此处的镜像仓库地址改为国内阿里云镜像仓库地址</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="string">v1.14.6</span>    <span class="comment">#指定k8s版本</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line"><span class="attr">  dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line"><span class="attr">  podSubnet:</span> <span class="string">"10.244.0.0/16"</span>    <span class="comment">#指定Pod的网络范围为10.244.0.0/16，若没有则flannel网络启动失败</span></span><br><span class="line"><span class="attr">  serviceSubnet:</span> <span class="number">10.1</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span>    <span class="comment">#指定SVC的网络范围</span></span><br><span class="line"><span class="attr">scheduler:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="预下载镜像"><a href="#预下载镜像" class="headerlink" title="预下载镜像"></a>预下载镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images pull --config kubeadm-init.yml</span><br></pre></td></tr></table></figure>
<h3 id="初始化第一个master-1"><a href="#初始化第一个master-1" class="headerlink" title="初始化第一个master"></a>初始化第一个master</h3><p>执行如下指令进行初始化第一个master节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config kubeadm-init.yml</span><br></pre></td></tr></table></figure>
<p>初始化成功后，会看到大概如下提示，下面信息先保留，后续添加master节点和node节点需要用到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of control-plane nodes by copying certificate authorities</span><br><span class="line">and service account keys on each node and then running the following as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join 10.211.55.10:8443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:a0816d4859bcb4e84e25c5c87c5495e9b9e38486d3bfb3d71bc28e1ff8451e13 \</span><br><span class="line">    --experimental-control-plane</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 10.211.55.10:8443 --token abcdef.0123456789abcdef \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:a0816d4859bcb4e84e25c5c87c5495e9b9e38486d3bfb3d71bc28e1ff8451e13</span><br></pre></td></tr></table></figure>
<h3 id="配置kubectl的config文件-1"><a href="#配置kubectl的config文件-1" class="headerlink" title="配置kubectl的config文件"></a>配置kubectl的config文件</h3><p>kubectl默认会在执行的用户家目录下面的.kube目录下寻找config文件。按照上面输出的提示执行如下指令将在初始化时[kubeconfig]步骤生成的admin.conf拷贝到.kube/config，因为此配置文件中记录了apiserver的访问地址，所以后面直接执行kubectl命令就可以正常连接到APIServer中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>
<p>此时使用kubectl  get node能看到第一个master节点还处于NotReady状态，这是因为现在还没安装网络</p>
<h3 id="安装网络-1"><a href="#安装网络-1" class="headerlink" title="安装网络"></a>安装网络</h3><p>在任意一台master节点执行如下指令下载网络yaml文件，k8s支持多种网络类型，本文安装的是flannel网络，更多网络类型可参考<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/</span><br><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>
<p>根据实际环境情况修改kube-flannel.yml文件，比如Network、Backend、hostNetwork配置等等，Network配置的网络范围要与kubeadm-init.yml中的podSubnet一致，修改完成后进行安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/</span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure>
<p>查看flannel的pod创建情况，等待到所有node节点上的flannel pod都处于running状态后表示cni部署完成</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system -o wide</span><br></pre></td></tr></table></figure>
<h1 id="加入剩余的master"><a href="#加入剩余的master" class="headerlink" title="加入剩余的master"></a>加入剩余的master</h1><hr>
<h2 id="新版本kubeadm-1"><a href="#新版本kubeadm-1" class="headerlink" title="新版本kubeadm"></a>新版本kubeadm</h2><p>在剩余的master节点上运行如下指令进行初始化并配置kube的config文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 10.211.55.10:6443 --token y55nex.s699ytnwr28o1vu1 \</span><br><span class="line">  --discovery-token-ca-cert-hash sha256:dd0932f4d17a864cf4ea3a7eff44c77695b47f39de03eaaf1dfd27762d7dd48b \</span><br><span class="line">  --control-plane --certificate-key b2ef4609c5af0d51334d49b20a3713e073ef818593d830b5b17ac58b294cc5c0</span><br><span class="line"></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>
<h2 id="旧版本kubeadm-1"><a href="#旧版本kubeadm-1" class="headerlink" title="旧版本kubeadm"></a>旧版本kubeadm</h2><p>在第一台master节点上创建如下内容的脚本（假设为add_master.sh）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CONTROL_PLANE_IPS="k8s-master2 k8s-master3"</span><br><span class="line">for host in $&#123;CONTROL_PLANE_IPS&#125;</span><br><span class="line">do</span><br><span class="line">    ssh root@$&#123;host&#125; "mkdir -p /etc/kubernetes/pki/etcd"</span><br><span class="line">    scp -r /etc/kubernetes/pki/ca.* root@$&#123;host&#125;:/etc/kubernetes/pki/</span><br><span class="line">    scp -r /etc/kubernetes/pki/sa.* root@$&#123;host&#125;:/etc/kubernetes/pki/</span><br><span class="line">    scp -r /etc/kubernetes/pki/front-proxy-ca.* root@$&#123;host&#125;:/etc/kubernetes/pki/</span><br><span class="line">    scp -r /etc/kubernetes/pki/etcd/ca.* root@$&#123;host&#125;:/etc/kubernetes/pki/etcd/</span><br><span class="line">    scp -r /etc/kubernetes/admin.conf root@$&#123;host&#125;:/etc/kubernetes/</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p><strong>CONTROL_PLANE_IPS变量设置其余master的主机名或者IP，之间用空格隔开(若设置主机名需要确保配置有解析)</strong></p>
<p>配置好ONTROL_PLANE_IPS后运行脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh add_master.sh</span><br></pre></td></tr></table></figure>
<p>在剩余的master节点上运行如下指令进行初始化并配置kube的config文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 10.211.55.10:8443 --token abcdef.0123456789abcdef \</span><br><span class="line">  --discovery-token-ca-cert-hash sha256:a0816d4859bcb4e84e25c5c87c5495e9b9e38486d3bfb3d71bc28e1ff8451e13 \</span><br><span class="line">  --experimental-control-plane</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>
<p><strong>注：</strong>默认情况下出于安全的考虑业务pods不会调度到控制节点上，如果想要让业务pods能够调度到控制节点上的话，可以在其中一台master节点上执行如下指令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes --all node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure>
<h1 id="加入Node"><a href="#加入Node" class="headerlink" title="加入Node"></a>加入Node</h1><hr>
<p>依此在node节点上运行如下指令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 10.211.55.10:6443 --token y55nex.s699ytnwr28o1vu1 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:dd0932f4d17a864cf4ea3a7eff44c77695b47f39de03eaaf1dfd27762d7dd48b</span><br></pre></td></tr></table></figure>
<h1 id="环境测试验证"><a href="#环境测试验证" class="headerlink" title="环境测试验证"></a>环境测试验证</h1><hr>
<p>在任意一个master节点上执行如下指令创建一个nginx pod并暴露端口测试是否可以从外部正常访问</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建nginx deployment</span></span><br><span class="line">kubectl create deployment web --image=nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">暴露端口</span></span><br><span class="line">kubectl expose deployment web --port=80 --type=NodePort</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看对应的访问端口</span></span><br><span class="line">kubectl get service</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">web          NodePort    10.1.153.72   &lt;none&gt;        80:30612/TCP   4s</span><br></pre></td></tr></table></figure>
<p>浏览器访问：http://&lt;Node_IP&gt;:30612若能正常返回nginx欢迎页面，则表示环境一切正常。</p>
<h1 id="部署Web-UI"><a href="#部署Web-UI" class="headerlink" title="部署Web UI"></a>部署Web UI</h1><hr>
<p>Github地址：<a href="https://github.com/kubernetes/dashboard" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard</a><br>官方地址：<a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/</a></p>
<p>在任意一台master节点上下载Web UI的yaml文件到/root目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta6/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure>
<p>编辑recommended.yaml文件，找到kubernetes-dashboard这个Service的部分，设置其type为NodePort，nodePort为30001（可自定义）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">8443</span></span><br><span class="line"><span class="attr">      nodePort:</span> <span class="number">30001</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br></pre></td></tr></table></figure>
<p>修改完成后，执行如下指令开始部署Web UI</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /root/recommended.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看kubernetes-dashboard的pod，确认pod的STATUS均为running再继续下面的步骤</span></span><br><span class="line">kubectl get pods -n kubernetes-dashboard</span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">dashboard-metrics-scraper-76585494d8-v4gd9   1/1     Running   0          63s</span><br><span class="line">kubernetes-dashboard-b65488c4-pwkc2          1/1     Running   0          63s</span><br></pre></td></tr></table></figure>
<p>创建service account并绑定默认cluster-admin管理员集群角色：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard</span><br><span class="line">kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin</span><br><span class="line">kubectl describe secrets -n kubernetes-dashboard $(kubectl -n kubernetes-dashboard get secret | awk '/dashboard-admin/&#123;print $1&#125;')</span><br></pre></td></tr></table></figure>
<p>使用上面输出的token登录Dashboard(https://&lt;NODE_IP&gt;:30001)。<strong>注意协议一定要用https</strong></p>
<p>**至此已经完成一套k8s集群的部署。若还需要再安装Helm、ingress-nginx、配置k8s对接外部存储做持久化存储，比如Ceph，可继续参考如下内容。</p>
<h1 id="安装helm"><a href="#安装helm" class="headerlink" title="安装helm"></a>安装helm</h1><hr>
<p>helm官网：<a href="https://helm.sh/" target="_blank" rel="noopener">https://helm.sh/</a></p>
<p>helm github：<a href="https://github.com/helm/helm" target="_blank" rel="noopener">https://github.com/helm/helm</a></p>
<p>下载所需版本的helm安装包（本文以2.16.1版本为例），上传到所有的master节点的/root/helm目录下(若没有此目录先创建)，执行如下指令安装helm客户端</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /root/helm</span><br><span class="line">tar zxf helm-v2.16.1-linux-amd64.tar.gz</span><br><span class="line">cd linux-amd64/</span><br><span class="line">cp -a helm  /usr/local/bin/</span><br></pre></td></tr></table></figure>
<p>在其中一台master运行如下指令安装helm服务端</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm init</span><br></pre></td></tr></table></figure>
<p>执行如下指令设置tiller的rbac权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount -n kube-system tiller</span><br><span class="line">kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span><br><span class="line">kubectl --namespace kube-system patch deploy tiller-deploy -p '&#123;"spec":&#123;"template":&#123;"spec":&#123;"serviceAccount":"tiller"&#125;&#125;&#125;&#125;'</span><br><span class="line">helm init --upgrade --service-account tiller</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">稍等片刻待tiller的pod处于均Ready后执行helm list看是否可以正常列出所有的release</span></span><br><span class="line">kubectl get pods -n kube-system  |grep tiller</span><br><span class="line">helm list</span><br><span class="line">helm version</span><br></pre></td></tr></table></figure>
<p>若执行helm version出现类似如下报错</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Client: &amp;version.Version&#123;SemVer:"v2.16.1", GitCommit:"bbdfe5e7803a12bbdf97e94cd847859890cf4050", GitTreeState:"clean"&#125;</span><br><span class="line">E1213 15:58:40.605638   10274 portforward.go:400] an error occurred forwarding 34583 -&gt; 44134: error forwarding port 44134 to pod 1e92153b279110f9464193c4ea7d6314ac69e70ce60e7319df9443e379b52ed4, uid : unable to do port forwarding: socat not found</span><br></pre></td></tr></table></figure>
<p>解决办法：</p>
<p>在所有node节点上安装socat</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install socat -y</span><br></pre></td></tr></table></figure>
<h1 id="安装ingress-nginx"><a href="#安装ingress-nginx" class="headerlink" title="安装ingress-nginx"></a>安装ingress-nginx</h1><hr>
<p>ingress-nginx官网：<a href="https://kubernetes.github.io/ingress-nginx/" target="_blank" rel="noopener">https://kubernetes.github.io/ingress-nginx/</a></p>
<p>ingress-nginx github：<a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">https://github.com/kubernetes/ingress-nginx</a></p>
<p>在任意一台master节点上下载ingress-nginx的yaml文件到/root目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml</span><br></pre></td></tr></table></figure>
<p>编辑mandatory.yaml文件，设置ingress-nginx的部署模式，本文采用hostNetwork模式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-ingress-controller</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line">    <span class="string">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="string">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line">      <span class="string">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">      <span class="string">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line">        <span class="string">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">        <span class="string">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">      annotations:</span></span><br><span class="line">        <span class="string">prometheus.io/port:</span> <span class="string">"10254"</span></span><br><span class="line">        <span class="string">prometheus.io/scrape:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span>    <span class="comment">#添加此行设置ingress-nginx的部署模式为hostNetwork</span></span><br><span class="line">      <span class="comment"># wait up to five minutes for the drain of connections</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">nginx-ingress-serviceaccount</span></span><br><span class="line"><span class="attr">      nodeSelector:</span></span><br><span class="line">        <span class="string">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>运行如下指令安装ingress-nginx</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /root/</span><br><span class="line">kubectl apply -f mandatory.yaml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">确认ingress-nginx的pod是否正常启动，处于running状态</span></span><br><span class="line">kubectl get pods -n ingress-nginx</span><br></pre></td></tr></table></figure>
<h1 id="配置rbd-provisioner"><a href="#配置rbd-provisioner" class="headerlink" title="配置rbd-provisioner"></a>配置rbd-provisioner</h1><hr>
<p><strong>K8S要对接Ceph RBD存储做持久化存储，首先必须要搭建Ceph存储集群，并在K8S的所有节点上安装对应版本的ceph-common客户端命令。关于Ceph集群的搭建和ceph-common此处不进行赘述，可参考<a href="https://docs.ceph.com/docs/master/" target="_blank" rel="noopener">Ceph官网文档</a>进行。</strong></p>
<p>Ceph集群和ceph-common安装都完成后，在其中一台master上创建/root/rbd-provisioner目录下，并执行如下指令创建rbd-provisioner所需的yaml文件，标注部分根据实际情况进行修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/rbd-provisioner</span><br><span class="line">cd /root/rbd-provisioner</span><br><span class="line"></span><br><span class="line">cat &gt; clusterrole.yaml &lt;&lt; EOF</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["persistentvolumes"]</span><br><span class="line">    verbs: ["get", "list", "watch", "create", "delete"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["persistentvolumeclaims"]</span><br><span class="line">    verbs: ["get", "list", "watch", "update"]</span><br><span class="line">  - apiGroups: ["storage.k8s.io"]</span><br><span class="line">    resources: ["storageclasses"]</span><br><span class="line">    verbs: ["get", "list", "watch"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["events"]</span><br><span class="line">    verbs: ["create", "update", "patch"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["services"]</span><br><span class="line">    resourceNames: ["kube-dns","coredns"]</span><br><span class="line">    verbs: ["list", "get"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["endpoints"]</span><br><span class="line">    verbs: ["get", "list", "watch", "create", "update", "patch"]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; clusterrolebinding.yaml &lt;&lt; EOF</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: rbd-provisioner</span><br><span class="line">    namespace: ceph</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; deployment.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: rbd-provisioner</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: rbd-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: rbd-provisioner</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        image: "quay.io/external_storage/rbd-provisioner:latest"</span><br><span class="line">        env:</span><br><span class="line">        - name: PROVISIONER_NAME</span><br><span class="line">          value: ceph.com/rbd</span><br><span class="line">      serviceAccount: rbd-provisioner</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; role.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [""]</span><br><span class="line">  resources: ["secrets"]</span><br><span class="line">  verbs: ["get"]</span><br><span class="line">- apiGroups: [""]</span><br><span class="line">  resources: ["endpoints"]</span><br><span class="line">  verbs: ["get", "list", "watch", "create", "update", "patch"]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; rolebinding.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; serviceaccount.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: rbd-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; storageclass.yaml &lt;&lt; EOF</span><br><span class="line">kind: StorageClass</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    storageclass.beta.kubernetes.io/is-default-class: "true"</span><br><span class="line">  name: rbd</span><br><span class="line">provisioner: ceph.com/rbd</span><br><span class="line">parameters:</span><br><span class="line">  monitors: 10.211.55.4:6789,10.211.55.5:6789,10.211.55.6:6789    #配置Ceph集群的monitor节点信息</span><br><span class="line">  pool: k8s    #配置要连接的pool，若没有需要先在ceph集群上创建</span><br><span class="line">  adminId: admin</span><br><span class="line">  adminSecretNamespace: ceph</span><br><span class="line">  adminSecretName: ceph-secret</span><br><span class="line">  fsType: ext4</span><br><span class="line">  userId: admin</span><br><span class="line">  userSecretNamespace: ceph</span><br><span class="line">  userSecretName: ceph-secret</span><br><span class="line">  imageFormat: "2"</span><br><span class="line">  imageFeatures: layering</span><br><span class="line">reclaimPolicy: Delete</span><br><span class="line">volumeBindingMode: Immediate</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; secrets.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: ceph-secret</span><br><span class="line">  namespace: ceph</span><br><span class="line">type: "ceph.com/rbd"</span><br><span class="line">data:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> ceph auth add client.kube mon <span class="string">'allow r'</span> osd <span class="string">'allow rwx pool=kube'</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> ceph auth get-key client.admin | base64</span></span><br><span class="line">  key: QVFEcTN5VmRvK28xRHhBQUlKNW5zQ0xwcTd3N0Q5OTJENm9YeGc9PQ==    #配置Ceph集群的kering，此处填的是经过base64编码后的值</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>执行如下执行创建rbd storageclass</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /root/rbd-provisioner</span><br><span class="line">kubectl create namespace ceph</span><br><span class="line">kubectl apply -f storageclass.yaml -f clusterrolebinding.yaml -f clusterrole.yaml -f deployment.yaml -f rolebinding.yaml -f role.yaml -f secrets.yaml -f serviceaccount.yaml</span><br><span class="line">kubectl get pods -n ceph | grep rbd-provisioner</span><br></pre></td></tr></table></figure>
<h1 id="配置cephfs-provisioner"><a href="#配置cephfs-provisioner" class="headerlink" title="配置cephfs-provisioner"></a>配置cephfs-provisioner</h1><hr>
<p><strong>K8S要对接CephFS存储做持久化存储，首先必须要搭建Ceph存储集群，并在K8S的所有节点上安装对应版本的ceph-common客户端命令。关于Ceph集群的搭建和ceph-common此处不进行赘述，可参考<a href="https://docs.ceph.com/docs/master/" target="_blank" rel="noopener">Ceph官网文档</a>进行。</strong></p>
<p>Ceph集群和ceph-common安装都完成后，在其中一台master上创建/root/cephfs-provisioner目录下，并执行如下指令创建cephfs-provisioner所需的yaml文件，标注部分根据实际情况进行修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/cephfs-provisioner</span><br><span class="line">cd /root/cephfs-provisioner</span><br><span class="line"></span><br><span class="line">cat &gt; clusterrole.yaml &lt;&lt; EOF</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["persistentvolumes"]</span><br><span class="line">    verbs: ["get", "list", "watch", "create", "delete"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["persistentvolumeclaims"]</span><br><span class="line">    verbs: ["get", "list", "watch", "update"]</span><br><span class="line">  - apiGroups: ["storage.k8s.io"]</span><br><span class="line">    resources: ["storageclasses"]</span><br><span class="line">    verbs: ["get", "list", "watch"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["events"]</span><br><span class="line">    verbs: ["create", "update", "patch"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["services"]</span><br><span class="line">    resourceNames: ["kube-dns","coredns"]</span><br><span class="line">    verbs: ["list", "get"]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; clusterrolebinding.yaml &lt;&lt; EOF</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: cephfs-provisioner</span><br><span class="line">    namespace: ceph</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; deployment.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: cephfs-provisioner</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: cephfs-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: cephfs-provisioner</span><br><span class="line">        image: "quay.io/external_storage/cephfs-provisioner:latest"</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        env:</span><br><span class="line">        - name: PROVISIONER_NAME</span><br><span class="line">          value: ceph.com/cephfs</span><br><span class="line">        - name: PROVISIONER_SECRET_NAMESPACE</span><br><span class="line">          value: ceph</span><br><span class="line">        command:</span><br><span class="line">        - "/usr/local/bin/cephfs-provisioner"</span><br><span class="line">        args:</span><br><span class="line">        - "-id=cephfs-provisioner-1"</span><br><span class="line">        - "-disable-ceph-namespace-isolation=true"</span><br><span class="line">        - "-enable-quota=true"</span><br><span class="line">      serviceAccount: cephfs-provisioner</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; role.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["secrets"]</span><br><span class="line">    verbs: ["create", "get", "delete"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["endpoints"]</span><br><span class="line">    verbs: ["get", "list", "watch", "create", "update", "patch"]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; rolebinding.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat  &gt; serviceaccount.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: cephfs-provisioner</span><br><span class="line">  namespace: ceph</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; storageclass.yaml &lt;&lt; EOF</span><br><span class="line">kind: StorageClass</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: cephfs</span><br><span class="line">provisioner: ceph.com/cephfs</span><br><span class="line">parameters:</span><br><span class="line">    monitors: 10.211.55.4:6789,10.211.55.5:6789,10.211.55.6:6789    #配置Ceph集群的monitor节点信息</span><br><span class="line">    adminId: admin</span><br><span class="line">    adminSecretName: ceph-secret</span><br><span class="line">    adminSecretNamespace: "ceph"</span><br><span class="line">reclaimPolicy: Delete</span><br><span class="line">volumeBindingMode: Immediate</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>执行如下指令创建cephfs storageclass</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /root/cephfs-provisioner</span><br><span class="line">kubectl apply -f storageclass.yaml -f clusterrolebinding.yaml -f clusterrole.yaml -f deployment.yaml -f rolebinding.yaml -f role.yaml -f serviceaccount.yaml</span><br><span class="line">kubectl get pods -n ceph | grep cephfs-provisioner</span><br></pre></td></tr></table></figure>
<p>参考链接：</p>
<p><a href="https://kubernetes.io/docs/setup/" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/</a></p>
<p><a href="https://docs.docker.com/install/linux/docker-ce/centos/" target="_blank" rel="noopener">https://docs.docker.com/install/linux/docker-ce/centos/</a></p>
<p><a href="https://blog.csdn.net/fuck487/article/details/102783300" target="_blank" rel="noopener">https://blog.csdn.net/fuck487/article/details/102783300</a></p>
<p><a href="https://github.com/kubernetes-incubator/external-storage" target="_blank" rel="noopener">https://github.com/kubernetes-incubator/external-storage</a></p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Koenli
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://www.koenli.com/13e99bd8.html" title="在CentOS7上使用kubeadm快速部署Kubernetes高可用集群">http://www.koenli.com/13e99bd8.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Docker/" rel="tag"># Docker</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2e84845e.html" rel="prev" title="在CentOS7上二进制部署Kubernetes高可用集群">
      <i class="fa fa-chevron-left"></i> 在CentOS7上二进制部署Kubernetes高可用集群
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
    <div>
        
        <div>
    
        <div class="end-slogan" style="text-align:center;font-size:13px;letter-spacing:10px;user-select:none;color:#bbb;"><br/>- - - - - - - - - 本文结束啦<i class="fa fa-star"></i>感谢您阅读 - - - - - - - - -<br/><br/></div>
    
</div> 

        
     </div>
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#环境要求"><span class="nav-number">1.</span> <span class="nav-text">环境要求</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Mater节点"><span class="nav-number">1.1.</span> <span class="nav-text">Mater节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Node节点"><span class="nav-number">1.2.</span> <span class="nav-text">Node节点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#操作系统版本"><span class="nav-number">2.</span> <span class="nav-text">操作系统版本</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实验环境信息"><span class="nav-number">3.</span> <span class="nav-text">实验环境信息</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#系统初始化"><span class="nav-number">4.</span> <span class="nav-text">系统初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#关闭防火墙"><span class="nav-number">4.1.</span> <span class="nav-text">关闭防火墙</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关闭selinux"><span class="nav-number">4.2.</span> <span class="nav-text">关闭selinux</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关闭swap"><span class="nav-number">4.3.</span> <span class="nav-text">关闭swap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置主机名"><span class="nav-number">4.4.</span> <span class="nav-text">配置主机名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加所有节点的本地host解析"><span class="nav-number">4.5.</span> <span class="nav-text">添加所有节点的本地host解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装基础软件包"><span class="nav-number">4.6.</span> <span class="nav-text">安装基础软件包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内核开启网络支持"><span class="nav-number">4.7.</span> <span class="nav-text">内核开启网络支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置所有Master到所有节点（包括自身）的ssh免密登录"><span class="nav-number">4.8.</span> <span class="nav-text">配置所有Master到所有节点（包括自身）的ssh免密登录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#节点之间时间同步"><span class="nav-number">4.9.</span> <span class="nav-text">节点之间时间同步</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Server端"><span class="nav-number">4.9.1.</span> <span class="nav-text">Server端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Client端"><span class="nav-number">4.9.2.</span> <span class="nav-text">Client端</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#所有节点（Master和Node）安装docker"><span class="nav-number">5.</span> <span class="nav-text">所有节点（Master和Node）安装docker</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#卸载旧版本的Docker"><span class="nav-number">5.1.</span> <span class="nav-text">卸载旧版本的Docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置docker-ce-repository"><span class="nav-number">5.2.</span> <span class="nav-text">配置docker-ce repository</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装docker-ce"><span class="nav-number">5.3.</span> <span class="nav-text">安装docker-ce</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动Docker并设置开机自启"><span class="nav-number">5.4.</span> <span class="nav-text">启动Docker并设置开机自启</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#所有节点（Master和Node）安装kubeadm、kubelet和kubectl"><span class="nav-number">6.</span> <span class="nav-text">所有节点（Master和Node）安装kubeadm、kubelet和kubectl</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置kubernetes-repository"><span class="nav-number">6.1.</span> <span class="nav-text">配置kubernetes repository</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关闭selinux-1"><span class="nav-number">6.2.</span> <span class="nav-text">关闭selinux</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#打开net-bridge-bridge-nf-call-iptables内核参数"><span class="nav-number">6.3.</span> <span class="nav-text">打开net.bridge.bridge-nf-call-iptables内核参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装kubeadm、kubelet和kubectl"><span class="nav-number">6.4.</span> <span class="nav-text">安装kubeadm、kubelet和kubectl</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#所有的Master上配置Keepalived和HAProxy（单Master节点部署忽略此步）"><span class="nav-number">7.</span> <span class="nav-text">所有的Master上配置Keepalived和HAProxy（单Master节点部署忽略此步）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Keepalived"><span class="nav-number">7.1.</span> <span class="nav-text">Keepalived</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HAProxy"><span class="nav-number">7.2.</span> <span class="nav-text">HAProxy</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#初始化第一台Master"><span class="nav-number">8.</span> <span class="nav-text">初始化第一台Master</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#新版本kubeadm"><span class="nav-number">8.1.</span> <span class="nav-text">新版本kubeadm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化第一个master"><span class="nav-number">8.1.1.</span> <span class="nav-text">初始化第一个master</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置kubectl的config文件"><span class="nav-number">8.1.2.</span> <span class="nav-text">配置kubectl的config文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装网络"><span class="nav-number">8.1.3.</span> <span class="nav-text">安装网络</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#旧版本kubeadm"><span class="nav-number">8.2.</span> <span class="nav-text">旧版本kubeadm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#修改初始化配置文件"><span class="nav-number">8.2.1.</span> <span class="nav-text">修改初始化配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#预下载镜像"><span class="nav-number">8.2.2.</span> <span class="nav-text">预下载镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化第一个master-1"><span class="nav-number">8.2.3.</span> <span class="nav-text">初始化第一个master</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置kubectl的config文件-1"><span class="nav-number">8.2.4.</span> <span class="nav-text">配置kubectl的config文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装网络-1"><span class="nav-number">8.2.5.</span> <span class="nav-text">安装网络</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#加入剩余的master"><span class="nav-number">9.</span> <span class="nav-text">加入剩余的master</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#新版本kubeadm-1"><span class="nav-number">9.1.</span> <span class="nav-text">新版本kubeadm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#旧版本kubeadm-1"><span class="nav-number">9.2.</span> <span class="nav-text">旧版本kubeadm</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#加入Node"><span class="nav-number">10.</span> <span class="nav-text">加入Node</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#环境测试验证"><span class="nav-number">11.</span> <span class="nav-text">环境测试验证</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署Web-UI"><span class="nav-number">12.</span> <span class="nav-text">部署Web UI</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装helm"><span class="nav-number">13.</span> <span class="nav-text">安装helm</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装ingress-nginx"><span class="nav-number">14.</span> <span class="nav-text">安装ingress-nginx</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置rbd-provisioner"><span class="nav-number">15.</span> <span class="nav-text">配置rbd-provisioner</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置cephfs-provisioner"><span class="nav-number">16.</span> <span class="nav-text">配置cephfs-provisioner</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Koenli"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Koenli</p>
  <div class="site-description" itemprop="description">讨厌自己明明不甘平凡，却又不好好努力</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">39</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

      <!-- 添加canvas粒子时钟 -->
      
        
      
      <div style="">
  <canvas id="canvas" style="width:60%;">当前浏览器不支持canvas，请更换浏览器后再试</canvas>
</div>
<script>
(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //声明canvas的宽高
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //存储时间数据
    var data = [];
    //存储运动的小球
    var balls = [];
    //设置粒子半径
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //存储时间数字，由十位小时、个位小时、冒号、十位分钟、个位分钟、冒号、十位秒钟、个位秒钟这7个数字组成
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*生成点阵数字*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*更新时钟*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //时间发生变化
            if(NewData[i] !== data[i]){
                //将变化的数字值和在data数组中的索引存储在changeNumArray数组中
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //增加小球
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*更新小球状态*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*增加要运动的小球*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*渲染*/
    function render(){
        //重置画布宽度，达到清空画布的效果
        canvas.height = 100;
        //渲染时钟
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //渲染小球
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //更新时钟
        updateDigitTime();
        //更新小球状态
        updateBalls();
        //渲染
        render();
    },50);
}

})();
</script>



    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="beian"><a href="http://www.beian.miit.gov.cn" rel="noopener" target="_blank">粤ICP备 </a>
      <img src="https://img.koenli.com/%E5%A4%87%E6%A1%88%E5%9B%BE%E6%A0%87.png" style="display: inline-block;"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=18126773" rel="noopener" target="_blank">18126773号 </a>
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Koenli</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-ribbon@1/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'XD8aPBomWwb9OrD5OlP3F42U-gzGzoHsz',
      appKey     : 'EHcp6RUK4G6BGD0dqfrz0IDo',
      placeholder: "ヾﾉ≧∀≦)o来啊，快活啊!",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>
<div class="moon-menu">
  <div class="moon-menu-items">
    
    <div class="moon-menu-item" onclick="back2bottom()">
      <i class="fa fa-chevron-down"></i>
    </div>
    
    <div class="moon-menu-item" onclick="back2top()">
      <i class="fa fa-chevron-up"></i>
    </div>
    
  </div>
  <div class="moon-menu-button" onclick="moonMenuClick()">
    <svg class="moon-menu-svg">
      <circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle>
      <circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle>
      <g class="moon-menu-points">
        <circle class="moon-menu-point" r=".2rem" cx="0" cy="-.8rem"></circle>
        <circle class="moon-menu-point" r=".2rem"></circle>
        <circle class="moon-menu-point" r=".2rem" cx="0" cy=".8rem"></circle>
      </g>
    </svg>
    <div class="moon-menu-icon">
    </div>
    <div class="moon-menu-text">
    </div>
  </div>
</div>

<script>

  const moonMenuListener = function () {

    //Get scroll percent
    let offsetHeight = document.documentElement.offsetHeight;
    let scrollHeight = document.documentElement.scrollHeight;
    var scrollTop = document.documentElement.scrollTop || window.pageYOffset || document.body.scrollTop;
    let percent = Math.round(scrollTop / (scrollHeight - offsetHeight) * 100);
    if (percent > 100) percent = 100;

    let menuText = document.querySelector('.moon-menu-text');
    let menuPoints = document.querySelector('.moon-menu-points');
    if (!percent) {
      percent = 0;
      menuText.style.display = 'none';
      menuPoints.style.display = 'block';
    } else {
      menuText.style.display = 'block';
      menuPoints.style.display = 'none';
      menuText.innerHTML = percent + '%';
    }

    //Update strokeDasharray
    let length = 196;
    document.querySelector('.moon-menu-border').style.strokeDasharray = percent * length / 100 + ' ' + length;

  }

  window.addEventListener('load', () => {
    moonMenuListener();
  });
  window.addEventListener('scroll', moonMenuListener);

  const moonMenuClick = function () {
    let items = document.querySelector('.moon-menu-items')
    items.classList.toggle('active');
    let points = document.querySelectorAll('.moon-menu-point');
    let childItems = document.querySelectorAll('.moon-menu-item');
    if (items.classList.contains('active')) {
      points[0].setAttribute("cx", "-.8rem");
      points[0].setAttribute("cy", "0");
      points[2].setAttribute("cx", ".8rem");
      points[2].setAttribute("cy", "0");
      for (let i = 0; i < childItems.length; i++) {
        childItems[i].style.top = -3 - 3 * i + 'rem';
        childItems[i].style.opacity = .9;
      }
    } else {
      points[0].setAttribute("cx", "0");
      points[0].setAttribute("cy", "-.8rem");
      points[2].setAttribute("cx", "0");
      points[2].setAttribute("cy", ".8rem");
      for (let i = 0; i < childItems.length; i++) {
        childItems[i].style.top = '1rem';
        childItems[i].style.opacity = 0;
      }
    }
  };

  const back2top = () => {
    window.scroll({ top: 0, behavior: 'smooth' });
  }

  const back2bottom = () => {
    let offsetHeight = document.documentElement.offsetHeight;
    let scrollHeight = document.documentElement.scrollHeight;
    window.scroll({ top: (scrollHeight - offsetHeight), behavior: 'smooth' });
  }

</script>
</body>
</html>
<!--添加点击礼花特效-->
<script type="text/javascript" src="/js/clickfireworks.js"></script>
<!--添加评论输入礼花特效-->
<script src="/js/activate-power-mode.js"></script>
<script>
  POWERMODE.colorful = true; // 控制开启 / 开启礼花特效 
  POWERMODE.shake = false; // 控制开启 / 关闭屏幕震动特效
  document.body.addEventListener('input', POWERMODE);
</script>
